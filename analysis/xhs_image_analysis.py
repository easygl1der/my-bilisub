#!/usr/bin/env python3
"""
å°çº¢ä¹¦å›¾æ–‡ç¬”è®°åˆ†æå·¥å…·

åŠŸèƒ½ï¼š
1. ä»æœ¬åœ°å›¾ç‰‡æ–‡ä»¶å¤¹åˆ†æå°çº¢ä¹¦å›¾æ–‡ç¬”è®°
2. è‡ªåŠ¨è¯†åˆ«å†…å®¹é£æ ¼ç±»å‹
3. é’ˆå¯¹ä¸åŒé£æ ¼ä½¿ç”¨ä¸“é—¨çš„åˆ†ææç¤ºè¯
4. è¾“å‡ºç»“æ„åŒ–çš„çŸ¥è¯†åº“ç¬”è®°

æ”¯æŒçš„å†…å®¹é£æ ¼ç±»å‹ï¼š
- life_vlog: ç”Ÿæ´»è®°å½•/æ—¥å¸¸åˆ†äº«
- quote_wisdom: çº¯æ–‡å­—/é‡‘å¥/äººç”Ÿé“ç†
- news_info: æ–°é—»èµ„è®¯/çŸ¥è¯†ç§‘æ™®
- fashion_look: ç©¿æ­/ç¾å¦†/é¢œå€¼åˆ†äº«
- food_review: ç¾é£Ÿæ¢åº—/é£Ÿè°±åˆ†äº«
- travel_guide: æ—…è¡Œæ”»ç•¥/æ™¯ç‚¹æ¨è
- tech_review: æ•°ç æµ‹è¯„/äº§å“è¯„æµ‹
- study_notes: å­¦ä¹ ç¬”è®°/å¹²è´§æ•™ç¨‹

ä½¿ç”¨ç¤ºä¾‹:
    # åˆ†ææœ¬åœ°å›¾ç‰‡æ–‡ä»¶å¤¹
    python xhs_image_analysis.py --dir "xhs_images/ç”¨æˆ·å/ç¬”è®°æ ‡é¢˜"

    # æŒ‡å®šå†…å®¹é£æ ¼
    python xhs_image_analysis.py --dir "images" --style quote_wisdom

    # è‡ªåŠ¨è¯†åˆ«é£æ ¼ï¼ˆé»˜è®¤ï¼‰
    python xhs_image_analysis.py --dir "images" --auto-style

    # æ‰¹é‡åˆ†æç”¨æˆ·çš„æ‰€æœ‰ç¬”è®°
    python xhs_image_analysis.py --user-dir "xhs_images/å¡‘æ–™å‰FOKU"

    # è¯»å–æ–‡æ¡ˆæ–‡ä»¶
    python xhs_image_analysis.py --dir "images" --text-file "content.txt"
"""

import os
import sys
import time
import json
import re
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Optional, Tuple, Set

# Windowsç¼–ç ä¿®å¤
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

# å¿½ç•¥æ‰€æœ‰ FutureWarning
import warnings
warnings.filterwarnings("ignore", category=FutureWarning)

try:
    import google.generativeai as genai
    GENAI_AVAILABLE = True
except ImportError:
    print("âŒ æœªå®‰è£… google-generativeai åº“")
    print("è¯·è¿è¡Œ: pip install google-generativeai")
    sys.exit(1)


# ==================== é…ç½® ====================

GEMINI_MODELS = {
    'flash-lite': 'gemini-2.5-flash-lite',
    'flash': 'gemini-2.5-flash',
    'pro': 'gemini-2.5-pro',
}

# å†…å®¹é£æ ¼å®šä¹‰
CONTENT_STYLES = {
    'life_vlog': {
        'name': 'ç”Ÿæ´»è®°å½•/æ—¥å¸¸åˆ†äº«',
        'description': 'è®°å½•æ—¥å¸¸ç”Ÿæ´»ã€å¿ƒæƒ…ã€éšæƒ³ç­‰å†…å®¹',
        'keywords': ['æ—¥å¸¸', 'ç”Ÿæ´»', 'åˆ†äº«', 'å¿ƒæƒ…', 'è®°å½•', 'vlog', 'éšæ‹'],
    },
    'quote_wisdom': {
        'name': 'çº¯æ–‡å­—/é‡‘å¥/äººç”Ÿé“ç†',
        'description': 'ä»¥æ–‡å­—ä¸ºä¸»ï¼Œåˆ†äº«äººç”Ÿæ„Ÿæ‚Ÿã€é“ç†ã€åè¨€è­¦å¥',
        'keywords': ['é“ç†', 'æ„Ÿæ‚Ÿ', 'äººç”Ÿ', 'æ™ºæ…§', 'è¯­å½•', 'åè¨€', 'è­¦å¥', 'æ–‡æ¡ˆ'],
    },
    'news_info': {
        'name': 'æ–°é—»èµ„è®¯/çŸ¥è¯†ç§‘æ™®',
        'description': 'åˆ†äº«æ–°é—»äº‹ä»¶ã€ç§‘æ™®çŸ¥è¯†ã€è¡Œä¸šåŠ¨æ€',
        'keywords': ['æ–°é—»', 'èµ„è®¯', 'ç§‘æ™®', 'çŸ¥è¯†', 'çƒ­ç‚¹', 'åŠ¨æ€', 'æŠ¥é“'],
    },
    'fashion_look': {
        'name': 'ç©¿æ­/ç¾å¦†/é¢œå€¼åˆ†äº«',
        'description': 'æœè£…æ­é…ã€ç¾å¦†æ•™ç¨‹ã€é¢œå€¼å±•ç¤º',
        'keywords': ['ç©¿æ­', 'æ­é…', 'OOTD', 'ç¾å¦†', 'å¦†å®¹', 'é¢œå€¼', 'é€ å‹'],
    },
    'food_review': {
        'name': 'ç¾é£Ÿæ¢åº—/é£Ÿè°±åˆ†äº«',
        'description': 'é¤å…æ¢åº—ã€ç¾é£Ÿåˆ¶ä½œã€é£Ÿè°±åˆ†äº«',
        'keywords': ['ç¾é£Ÿ', 'æ¢åº—', 'é¤å…', 'é£Ÿè°±', 'åšé¥­', 'èœè°±', 'å°åƒ'],
    },
    'travel_guide': {
        'name': 'æ—…è¡Œæ”»ç•¥/æ™¯ç‚¹æ¨è',
        'description': 'æ—…è¡Œæ”»ç•¥ã€æ™¯ç‚¹æ¨èã€è¡Œç¨‹åˆ†äº«',
        'keywords': ['æ—…è¡Œ', 'æ”»ç•¥', 'æ™¯ç‚¹', 'æ‰“å¡', 'æ¸¸ç©', 'è·¯çº¿', 'æ”»ç•¥'],
    },
    'tech_review': {
        'name': 'æ•°ç æµ‹è¯„/äº§å“è¯„æµ‹',
        'description': 'æ•°ç äº§å“æµ‹è¯„ã€å¼€ç®±ã€ä½¿ç”¨ä½“éªŒ',
        'keywords': ['æµ‹è¯„', 'å¼€ç®±', 'æ•°ç ', 'äº§å“', 'ä½“éªŒ', 'è¯„æµ‹', 'è®¾å¤‡'],
    },
    'study_notes': {
        'name': 'å­¦ä¹ ç¬”è®°/å¹²è´§æ•™ç¨‹',
        'description': 'å­¦ä¹ ç¬”è®°ã€æ•™ç¨‹ã€å¹²è´§åˆ†äº«',
        'keywords': ['ç¬”è®°', 'æ•™ç¨‹', 'å¹²è´§', 'å­¦ä¹ ', 'åˆ†äº«', 'æŠ€å·§', 'æ–¹æ³•'],
    },
}

# ==================== æç¤ºè¯æ¨¡æ¿ ====================

STYLE_PROMPTS = {
    'life_vlog': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç”Ÿæ´»è®°å½•å†…å®¹åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„ç”Ÿæ´»è®°å½•ç±»å›¾æ–‡ç¬”è®°ï¼Œè¾“å‡ºç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Šã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **å†…å®¹ç±»å‹**: ç”Ÿæ´»è®°å½•/æ—¥å¸¸åˆ†äº«
- **æ ¸å¿ƒä¸»é¢˜**: [ä¸€å¥è¯æ¦‚æ‹¬è¿™ç¯‡ç”Ÿæ´»è®°å½•çš„ä¸»é¢˜]
- **è®°å½•åœºæ™¯**: [å±…å®¶/å¤–å‡º/å·¥ä½œ/å­¦ä¹ /æ—…è¡Œ/èšä¼š/å…¶ä»–]
- **æƒ…ç»ªåŸºè°ƒ**: [å¼€å¿ƒ/æ¸©é¦¨/å¹³é™/å¿§ä¼¤/å…´å¥‹/å…¶ä»–]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ100-200å­—ï¼‰
[ç”¨ç²¾ç‚¼çš„è¯­è¨€æ¦‚æ‹¬ç”Ÿæ´»è®°å½•çš„æ ¸å¿ƒå†…å®¹å’Œæƒ…å¢ƒ]

## ğŸ¯ ç”Ÿæ´»ç»†èŠ‚æ•æ‰
### åœºæ™¯æè¿°
- **ç¯å¢ƒ**: [è®°å½•çš„åœºæ‰€ç¯å¢ƒç‰¹ç‚¹]
- **æ—¶é—´**: [å¤§æ¦‚çš„æ—¶é—´æ®µï¼Œå¦‚æ—©æ™¨/åˆå/å¤œæ™šç­‰]
- **æ°›å›´**: [æ•´ä½“æ°›å›´æ„Ÿå—]

### å…³é”®å…ƒç´ 
[åˆ—ä¸¾å›¾æ–‡ä¸­çš„å…³é”®å…ƒç´ ï¼Œå¦‚äººç‰©ã€ç‰©å“ã€åœºæ™¯ç­‰]
- å…ƒç´ 1: [æè¿°]
- å…ƒç´ 2: [æè¿°]

## ğŸ’­ æƒ…æ„Ÿä¸å…±é¸£
### ä½œè€…æƒ…ç»ª
- **ä¸»è¦æƒ…ç»ª**: [ä½œè€…é€šè¿‡å†…å®¹è¡¨è¾¾çš„ä¸»è¦æƒ…ç»ª]
- **æƒ…ç»ªè¡¨è¾¾æ–¹å¼**: [ç›´æ¥è¡¨è¾¾/å«è“„æµéœ²/å…¶ä»–]

### å…±é¸£ç‚¹åˆ†æ
[å†…å®¹å¯èƒ½å¼•èµ·è¯»è€…å…±é¸£çš„åœ°æ–¹]
- **æƒ…æ„Ÿå…±é¸£**: [ä»€ä¹ˆæ ·çš„æƒ…æ„Ÿå…±é¸£]
- **åœºæ™¯å…±é¸£**: [ä»€ä¹ˆæ ·çš„å…±åŒç»å†æˆ–åœºæ™¯]

## ğŸ“¸ è§†è§‰é£æ ¼åˆ†æ
- **å›¾ç‰‡é£æ ¼**: [è‡ªç„¶æŠ“æ‹/ç²¾å¿ƒæ‘†æ‹/è‡ªæ‹/ä»–æ‹/é™ç‰©ç‰¹å†™]
- **è‰²è°ƒæ°›å›´**: [æ¸©æš–/å†·æ·¡/æ˜äº®/æŸ”å’Œ/å…¶ä»–]
- **æ„å›¾ç‰¹ç‚¹**: [æ„å›¾æ–¹å¼çš„ç‰¹ç‚¹]
- **å®¡ç¾å–å‘**: [ä½œè€…çš„å®¡ç¾é£æ ¼å€¾å‘]

## âœ¨ çµæ„Ÿä¸å¯å‘
[ä»è¿™ç¯‡ç”Ÿæ´»è®°å½•ä¸­è·å¾—çš„å¯å‘æˆ–çµæ„Ÿ]
- **ç”Ÿæ´»æ–¹å¼å¯å‘**: [...]
- **å®¡ç¾å¯å‘**: [...]
- **æƒ…ç»ªä»·å€¼**: [ç»™äººä»€ä¹ˆæ„Ÿè§‰]

## ğŸ“ ä½œè€…ç”»åƒæ¨æ–­
åŸºäºå†…å®¹é£æ ¼ï¼Œæ¨æµ‹ä½œè€…çš„ç‰¹ç‚¹ï¼š
- **æ€§æ ¼å€¾å‘**: [æ´»æ³¼å¼€æœ—/å†…æ•›å®‰é™/å¹½é»˜é£è¶£/å…¶ä»–]
- **ç”Ÿæ´»æ€åº¦**: [ç§¯æä¹è§‚/éšæ€§è‡ªåœ¨/ç²¾è‡´ç”Ÿæ´»/å…¶ä»–]
- **å†…å®¹ç‰¹è‰²**: [ä½œè€…çš„ç”Ÿæ´»è®°å½•æœ‰ä»€ä¹ˆç‹¬ç‰¹ä¹‹å¤„]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",

    'quote_wisdom': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é‡‘å¥å’Œäººç”Ÿæ™ºæ…§å†…å®¹åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„ä»¥æ–‡å­—ä¸ºä¸»çš„å›¾æ–‡ç¬”è®°ï¼Œæå–å…¶ä¸­çš„äººç”Ÿæ™ºæ…§å’Œè¡¨è¾¾æŠ€å·§ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **å†…å®¹ç±»å‹**: çº¯æ–‡å­—/é‡‘å¥/äººç”Ÿé“ç†
- **æ ¸å¿ƒä¸»é¢˜**: [ä¸€å¥è¯æ¦‚æ‹¬æ ¸å¿ƒè§‚ç‚¹]
- **å†…å®¹å½¢å¼**: [å•å¥é‡‘å¥/å¤šæ¡è¯­å½•/æ®µè½è®ºè¿°/å¯¹è¯å½¢å¼]
- **è¡¨è¾¾é£æ ¼**: [ç›´æ¥è¯´ç†/æ¯”å–»ä¿®è¾/æ•…äº‹å¼•ç”³/å¯¹æ¯”è®ºè¯]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ100-200å­—ï¼‰
[æ¦‚æ‹¬æ–‡å­—å†…å®¹çš„æ ¸å¿ƒæ€æƒ³]

## ğŸ¯ æ ¸å¿ƒè§‚ç‚¹æå–
### ä¸»è¦è®ºç‚¹
[æç‚¼å‡ºæ–‡å­—çš„æ ¸å¿ƒè§‚ç‚¹]
- **è§‚ç‚¹1**: [è¯¦ç»†è¯´æ˜]
- **è§‚ç‚¹2**: [è¯¦ç»†è¯´æ˜]
- **è§‚ç‚¹3**: [è¯¦ç»†è¯´æ˜]

### è®ºè¯é€»è¾‘
[åˆ†æä½œè€…æ˜¯å¦‚ä½•å±•å¼€è®ºè¿°çš„]
- **è®ºè¯æ–¹å¼**: [è®²é“ç†/ä¸¾ä¾‹å­/æ‰“æ¯”æ–¹/å¼•ç”¨åè¨€]
- **é€»è¾‘ç»“æ„**: [å¦‚ä½•å±‚å±‚é€’è¿›]

## ğŸ’ é‡‘å¥æå–
### åŸåˆ›é‡‘å¥
[æå–æ–‡ä¸­ç²¾è¾Ÿã€æœ‰åˆ›æ„çš„å¥å­]
1. "åŸå¥å†…å®¹"
   - è§£æ: [ä¸ºä»€ä¹ˆè¿™å¥è¯æœ‰ä»·å€¼]

2. "åŸå¥å†…å®¹"
   - è§£æ: [...]

### å¼•ç”¨/åŒ–ç”¨
[å¦‚æœå†…å®¹å¼•ç”¨äº†åè¨€ã€ä¿—è¯­ç­‰]
- **å¼•ç”¨å†…å®¹**: "..."
- **å‡ºå¤„**: [å¦‚æœèƒ½è¯†åˆ«]
- **åŒ–ç”¨æ–¹å¼**: [å¦‚ä½•åŒ–ç”¨æˆ–æ”¹ç¼–]

## ğŸ¨ è¡¨è¾¾æŠ€å·§åˆ†æ
### ä¿®è¾æ‰‹æ³•
- **ä¿®è¾1**: [æ¯”å–»/æ’æ¯”/å¯¹æ¯”/è®¾é—®ç­‰] - [ä¸¾ä¾‹è¯´æ˜]
- **ä¿®è¾2**: [...] - [...]

### è¯­è¨€ç‰¹è‰²
- **è¡¨è¾¾é£æ ¼**: [ç®€æ´æœ‰åŠ›/æ¸©æš–æ²»æ„ˆ/çŠ€åˆ©ç›´æ¥/å¹½é»˜é£è¶£]
- **èŠ‚å¥æ„Ÿ**: [é•¿çŸ­å¥æ­é…ã€éŸµå¾‹ç‰¹ç‚¹]
- **å…³é”®è¯**: [åå¤å‡ºç°æˆ–å¼ºè°ƒçš„å…³é”®è¯]

## ğŸ§  è®¤çŸ¥ä»·å€¼åˆ†æ
### æ™ºæ…§ç±»å‹
- **æ™ºæ…§ç±»å‹**: [äººç”Ÿå“²ç†/å¤„ä¸–æ™ºæ…§/æƒ…æ„Ÿè®¤çŸ¥/æˆé•¿æ€ç»´/å…¶ä»–]
- **æ–°é¢–æ€§**: [â˜…â˜…â˜…â˜…â˜…] - [è§‚ç‚¹æ˜¯å¦æ–°é¢–ç‹¬ç‰¹]
- **æ™®é€‚æ€§**: [â˜…â˜…â˜…â˜…â˜…] - [é€‚ç”¨èŒƒå›´å¤šå¹¿]

### å¯å‘æ€§
[è¿™äº›è§‚ç‚¹ç»™äººä»€ä¹ˆå¯å‘]
- **è®¤çŸ¥å¯å‘**: [å¯¹è®¤è¯†ä¸–ç•Œçš„å¯å‘]
- **è¡ŒåŠ¨å¯å‘**: [å¯¹å®è·µè¡ŒåŠ¨çš„å¯å‘]
- **æƒ…æ„Ÿå¯å‘**: [å¯¹æƒ…æ„Ÿæ€åº¦çš„å¯å‘]

## ğŸ“ æ–‡å­—é£æ ¼ç”»åƒ
- **ä½œè€…è°ƒæ€§**: [ç†æ€§æ€è¾¨/æƒ…æ„ŸæŠ’å‘/é¸¡æ±¤æ²»æ„ˆ/çŠ€åˆ©åæ§½]
- **è¡¨è¾¾ç‰¹è‰²**: [ä½œè€…çš„æ–‡å­—æœ‰ä»€ä¹ˆç‹¬ç‰¹é£æ ¼]
- **ç›®æ ‡å—ä¼—**: [å†…å®¹é¢å‘ä»€ä¹ˆæ ·çš„è¯»è€…]

## âš ï¸ æ‰¹åˆ¤æ€§æ€è€ƒ
### å†…å®¹è¯„ä¼°
- **è§‚ç‚¹å¯é æ€§**: [é«˜/ä¸­/ä½] - [ç†ç”±]
- **é€»è¾‘ä¸¥å¯†æ€§**: [é«˜/ä¸­/ä½] - [ç†ç”±]
- **æ½œåœ¨é—®é¢˜**: [æ˜¯å¦æœ‰é€»è¾‘æ¼æ´ã€è§‚ç‚¹åé¢‡ç­‰]

### ä½¿ç”¨å»ºè®®
- **é€‚ç”¨åœºæ™¯**: [è¿™äº›é“ç†é€‚åˆä»€ä¹ˆæƒ…å†µä¸‹å¼•ç”¨]
- **æ³¨æ„äº‹é¡¹**: [ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ä»€ä¹ˆ]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",

    'news_info': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–°é—»èµ„è®¯å’ŒçŸ¥è¯†ç§‘æ™®å†…å®¹åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„æ–°é—»èµ„è®¯/ç§‘æ™®çŸ¥è¯†ç±»å›¾æ–‡ç¬”è®°ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **å†…å®¹ç±»å‹**: æ–°é—»èµ„è®¯/çŸ¥è¯†ç§‘æ™®
- **æ ¸å¿ƒä¸»é¢˜**: [ä¸€å¥è¯æ¦‚æ‹¬ä¸»é¢˜]
- **å†…å®¹é¢†åŸŸ**: [ç§‘æŠ€/æ°‘ç”Ÿ/å¨±ä¹/è´¢ç»/å›½é™…/ä½“è‚²/å…¶ä»–]
- **æ—¶æ•ˆæ€§**: [çƒ­ç‚¹æ–°é—»/è¡Œä¸šåŠ¨æ€/çŸ¥è¯†ç§‘æ™®/å…¶ä»–]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ100-200å­—ï¼‰
[æ¦‚æ‹¬æ–°é—»/ç§‘æ™®çš„æ ¸å¿ƒå†…å®¹]

## ğŸ¯ å…³é”®ä¿¡æ¯æå–
### æ–°é—»è¦ç´ ï¼ˆå¦‚é€‚ç”¨ï¼‰
- **äº‹ä»¶æ—¶é—´**: [ä½•æ—¶å‘ç”Ÿ]
- **äº‹ä»¶åœ°ç‚¹**: [ä½•åœ°å‘ç”Ÿ]
- **æ¶‰åŠäººç‰©/æœºæ„**: [è°]
- **äº‹ä»¶ç»è¿‡**: [å‘ç”Ÿäº†ä»€ä¹ˆ]
- **å½±å“/æ„ä¹‰**: [æœ‰ä»€ä¹ˆå½±å“]

### çŸ¥è¯†è¦ç‚¹ï¼ˆå¦‚é€‚ç”¨ï¼‰
[ç§‘æ™®å†…å®¹çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹]
- **çŸ¥è¯†ç‚¹1**: [è¯¦ç»†è¯´æ˜]
- **çŸ¥è¯†ç‚¹2**: [è¯¦ç»†è¯´æ˜]
- **çŸ¥è¯†ç‚¹3**: [è¯¦ç»†è¯´æ˜]

## ğŸ“Š ä¿¡æ¯è´¨é‡è¯„ä¼°
### å¯é æ€§åˆ†æ
- **ä¿¡æ¯æ¥æº**: [å¦‚æœèƒ½æ¨æµ‹ä¿¡æ¯æº]
- **äº‹å®æ ¸æŸ¥**: [å“ªäº›ä¿¡æ¯å¯éªŒè¯]
- **å®Œæ•´æ€§**: [ä¿¡æ¯æ˜¯å¦å®Œæ•´/æœ‰æ— é—æ¼]

### å®¢è§‚æ€§
- **æŠ¥é“è§’åº¦**: [å®¢è§‚ä¸­ç«‹/æœ‰æ˜æ˜¾å€¾å‘]
- **ä¸»è§‚è‰²å½©**: [æ˜¯å¦æœ‰æ˜æ˜¾çš„ä¸ªäººè§‚ç‚¹/æƒ…ç»ª]
- **å¹³è¡¡æ€§**: [æ˜¯å¦æœ‰å¤šæ–¹è§‚ç‚¹]

## ğŸ’¡ çŸ¥è¯†ä»·å€¼
### æ–°é¢–æ€§
- **ä¿¡æ¯æ–°é²œåº¦**: [â˜…â˜…â˜…â˜…â˜…] - [ä¿¡æ¯æœ‰å¤šæ–°é²œ]
- **å†…å®¹ç¨€ç¼ºæ€§**: [â˜…â˜…â˜…â˜…â˜…] - [æ˜¯å¦éš¾ä»¥è·å–]

### å®ç”¨æ€§
- **çŸ¥è¯†ä»·å€¼**: [é«˜/ä¸­/ä½] - [è¯´æ˜ç†ç”±]
- **å¯æ“ä½œæ€§**: [é«˜/ä¸­/ä½] - [èƒ½å¦è½¬åŒ–ä¸ºè¡ŒåŠ¨]

## ğŸ”— å»¶ä¼¸äº†è§£
### ç›¸å…³èƒŒæ™¯
[è¡¥å……ç›¸å…³èƒŒæ™¯ä¿¡æ¯]
- **èƒŒæ™¯1**: [...]
- **èƒŒæ™¯2**: [...]

### å€¼å¾—å…³æ³¨
[åŸºäºæ­¤å†…å®¹ï¼Œå€¼å¾—è¿›ä¸€æ­¥äº†è§£çš„è¯é¢˜]
- **å»¶ä¼¸è¯é¢˜1**: [è¯´æ˜]
- **å»¶ä¼¸è¯é¢˜2**: [è¯´æ˜]

## ğŸ“ å†…å®¹é£æ ¼åˆ†æ
- **è¡¨è¾¾æ–¹å¼**: [ä¸“ä¸šä¸¥è°¨/é€šä¿—æ˜“æ‡‚/ç”ŸåŠ¨æœ‰è¶£/å…¶ä»–]
- **ç»“æ„ç‰¹ç‚¹**: [å†…å®¹å¦‚ä½•ç»„ç»‡]
- **å—ä¼—å®šä½**: [é¢å‘ä»€ä¹ˆæ ·çš„è¯»è€…]

## âš ï¸ æ³¨æ„äº‹é¡¹
[é˜…è¯»æ—¶éœ€è¦æ³¨æ„ä»€ä¹ˆ]
- **æ ¸å®å»ºè®®**: [å“ªäº›ä¿¡æ¯éœ€è¦è¿›ä¸€æ­¥æ ¸å®]
- **ç†è§£æç¤º**: [ç†è§£æ—¶éœ€è¦æ³¨æ„çš„è¦ç‚¹]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",

    'fashion_look': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç©¿æ­ç¾å¦†å†…å®¹åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„ç©¿æ­/ç¾å¦†ç±»å›¾æ–‡ç¬”è®°ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **å†…å®¹ç±»å‹**: ç©¿æ­/ç¾å¦†/é¢œå€¼åˆ†äº«
- **ä¸»é¢˜**: [ä¸€å¥è¯æ¦‚æ‹¬ç©¿æ­/ç¾å¦†ä¸»é¢˜]
- **é£æ ¼ç±»å‹**: [å¦‚ï¼šéŸ©ç³»/æ—¥ç³»/æ¬§ç¾/å¤å¤/ç®€çº¦/ç”œé…·ç­‰]
- **é€‚ç”¨åœºæ™¯**: [æ—¥å¸¸é€šå‹¤/çº¦ä¼š/èŒåœº/è¿åŠ¨/æ´¾å¯¹/å…¶ä»–]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ100-200å­—ï¼‰
[æ¦‚æ‹¬ç©¿æ­/ç¾å¦†çš„æ ¸å¿ƒå†…å®¹å’Œäº®ç‚¹]

## ğŸ‘” ç©¿æ­åˆ†æï¼ˆå¦‚é€‚ç”¨ï¼‰
### å•å“æ¸…å•
[æå–ç©¿æ­çš„å•å“ä¿¡æ¯]
- **ä¸Šè£…**: [é¢œè‰²/æ¬¾å¼/æè´¨/å“ç‰Œ]
- **ä¸‹è£…**: [é¢œè‰²/æ¬¾å¼/æè´¨/å“ç‰Œ]
- **å¤–å¥—**: [é¢œè‰²/æ¬¾å¼/æè´¨/å“ç‰Œ]
- **é‹å­**: [é¢œè‰²/æ¬¾å¼/æè´¨/å“ç‰Œ]
- **é…é¥°**: [åŒ…åŒ…/é¦–é¥°/å¸½å­ç­‰]

### ç©¿æ­æŠ€å·§
[åˆ†æç©¿æ­çš„æŠ€å·§å’Œæ€è·¯]
- **è‰²å½©æ­é…**: [é¢œè‰²å¦‚ä½•ç»„åˆ]
- **å±‚æ¬¡æ­é…**: [å¦‚ä½•è¿›è¡Œå±‚æ¬¡å ç©¿]
- **æ¯”ä¾‹æŠŠæ§**: [ä¸Šä¸‹è£…æ¯”ä¾‹ã€è…°çº¿ä½ç½®ç­‰]
- **é£æ ¼åè°ƒ**: [å¦‚ä½•è¥é€ æ•´ä½“é£æ ¼]

## ğŸ’„ ç¾å¦†åˆ†æï¼ˆå¦‚é€‚ç”¨ï¼‰
### å¦†å®¹è¦ç‚¹
- **åº•å¦†**: [ç²‰åº•è‰²å·/å¦†æ„Ÿç‰¹ç‚¹]
- **çœ¼å¦†**: [çœ¼å½±è‰²è°ƒ/çœ¼çº¿/ç«æ¯›ç‰¹ç‚¹]
- **å”‡å¦†**: [å£çº¢è‰²å·/è´¨åœ°]
- **ç‰¹è‰²**: [å¦†å®¹çš„äº®ç‚¹]

### æŠ¤è‚¤/å‘å‹ï¼ˆå¦‚æåˆ°ï¼‰
- **å‘å‹**: [å‘å‹ç‰¹ç‚¹]
- **æŠ¤è‚¤**: [æåˆ°çš„æŠ¤è‚¤äº§å“æˆ–å¿ƒå¾—]

## ğŸ¨ è§†è§‰åˆ†æ
### å›¾ç‰‡é£æ ¼
- **æ‹æ‘„åœºæ™¯**: [å®¤å†…/å®¤å¤–/ç‰¹å®šåœºæ‰€]
- **æ‹æ‘„è§’åº¦**: [å…¨èº«/åŠèº«/ç‰¹å†™/å¯¹é•œè‡ªæ‹ç­‰]
- **æ„å›¾ç‰¹ç‚¹**: [æ„å›¾æ–¹å¼]
- **å…‰çº¿è¿ç”¨**: [è‡ªç„¶å…‰/å®¤å†…å…‰/ä¾§å…‰ç­‰]

### è‰²å½©åˆ†æ
- **ä¸»è‰²è°ƒ**: [æ•´ä½“è‰²å½©å€¾å‘]
- **é…è‰²æ–¹æ¡ˆ**: [å¦‚ä½•è¿›è¡Œé¢œè‰²æ­é…]
- **è§†è§‰æ•ˆæœ**: [è‰²å½©ç»™äººçš„æ„Ÿå—]

## ğŸ’¡ å‚è€ƒä»·å€¼
### é€‚åˆäººç¾¤
- **ä½“å‹**: [é€‚åˆä»€ä¹ˆä½“å‹]
- **è‚¤è‰²**: [é€‚åˆä»€ä¹ˆè‚¤è‰²]
- **é£æ ¼åå¥½**: [é€‚åˆä»€ä¹ˆé£æ ¼åå¥½]
- **å¹´é¾„æ®µ**: [é€‚åˆä»€ä¹ˆå¹´é¾„æ®µ]

### å¯æ“ä½œæ€§
- **æ¨¡ä»¿éš¾åº¦**: [é«˜/ä¸­/ä½] - [è¯´æ˜]
- **å•å“è·å–**: [éš¾/ä¸­/æ˜“] - [è¯´æ˜]
- **æˆæœ¬ä¼°ç®—**: [é«˜/ä¸­/ä½] - [è¯´æ˜]

## ğŸ“ é£æ ¼æ€»ç»“
- **æ•´ä½“é£æ ¼å®šä½**: [ä¸€å¥è¯æ€»ç»“é£æ ¼]
- **ç©¿æ­/ç¾å¦†ç†å¿µ**: [ä½œè€…çš„é£æ ¼ç†å¿µ]
- **ç‰¹è‰²æ ‡ç­¾**: [å¦‚#æç®€ç©¿æ­#éŸ©ç³»å¦†å®¹#ç­‰]

## ğŸ”— ç›¸å…³æ¨è
[åŸºäºæ­¤é£æ ¼ï¼Œå€¼å¾—å°è¯•çš„ç±»ä¼¼æ­é…]
- **æ¨è1**: [è¯´æ˜]
- **æ¨è2**: [è¯´æ˜]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",

    'food_review': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¾é£Ÿå†…å®¹åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„ç¾é£Ÿç±»å›¾æ–‡ç¬”è®°ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **å†…å®¹ç±»å‹**: ç¾é£Ÿæ¢åº—/é£Ÿè°±åˆ†äº«
- **ä¸»é¢˜**: [ä¸€å¥è¯æ¦‚æ‹¬ç¾é£Ÿä¸»é¢˜]
- **ç¾é£Ÿç±»å‹**: [ä¸­é¤/è¥¿é¤/æ—¥æ–™/éŸ©æ–™/ä¸œå—äºšèœ/ç”œå“/å°åƒ/å…¶ä»–]
- **å†…å®¹å½¢å¼**: [æ¢åº—æµ‹è¯„/é£Ÿè°±æ•™ç¨‹/ç¾é£Ÿæ¨è]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ100-200å­—ï¼‰
[æ¦‚æ‹¬ç¾é£Ÿå†…å®¹çš„æ ¸å¿ƒä¿¡æ¯]

## ğŸ½ï¸ æ¢åº—åˆ†æï¼ˆå¦‚é€‚ç”¨ï¼‰
### åº—é“ºä¿¡æ¯
- **åº—å**: [å¦‚æœèƒ½è¯†åˆ«]
- **ä½ç½®**: [å¤§æ¦‚ä½ç½®]
- **äººå‡æ¶ˆè´¹**: [å¦‚æœèƒ½æ¨æµ‹]
- **æ¨èæŒ‡æ•°**: [â˜…â˜…â˜…â˜…â˜…]

### èœå“æµ‹è¯„
[åˆ†æçš„èœå“]
- **èœå“1**: [åç§° + å£æ„Ÿ/å‘³é“ + è¯„ä»·]
- **èœå“2**: [åç§° + å£æ„Ÿ/å‘³é“ + è¯„ä»·]
- **èœå“3**: [åç§° + å£æ„Ÿ/å‘³é“ + è¯„ä»·]

### æ¢åº—ä½“éªŒ
- **ç¯å¢ƒæ°›å›´**: [ç¯å¢ƒæè¿°]
- **æœåŠ¡ä½“éªŒ**: [æœåŠ¡è¯„ä»·]
- **æ€§ä»·æ¯”**: [é«˜/ä¸­/ä½]

## ğŸ‘¨â€ğŸ³ é£Ÿè°±åˆ†æï¼ˆå¦‚é€‚ç”¨ï¼‰
### é£Ÿææ¸…å•
- **ä¸»æ–™**: [åˆ—ä¸¾ä¸»è¦é£Ÿæ]
- **è¾…æ–™**: [åˆ—ä¸¾è¾…åŠ©é£Ÿæ]
- **è°ƒæ–™**: [åˆ—ä¸¾è°ƒæ–™]

### åˆ¶ä½œæ­¥éª¤
[æå–åˆ¶ä½œè¦ç‚¹]
- **æ­¥éª¤1**: [å…³é”®è¦ç‚¹]
- **æ­¥éª¤2**: [å…³é”®è¦ç‚¹]
- **æ­¥éª¤3**: [å…³é”®è¦ç‚¹]

### çƒ¹é¥ªæŠ€å·§
- **æŠ€å·§1**: [è¯´æ˜]
- **æŠ€å·§2**: [è¯´æ˜]

## ğŸ“¸ è§†è§‰å‘ˆç°
### å›¾ç‰‡ç‰¹ç‚¹
- **æ‹æ‘„é£æ ¼**: [ä¿¯æ‹/å¹³è§†/ç‰¹å†™/å¯¹ç„¦ç­‰]
- **æ„å›¾ç‰¹ç‚¹**: [æ„å›¾æ–¹å¼]
- **å…‰çº¿**: [è‡ªç„¶å…‰/å®¤å†…å…‰/è¡¥å…‰]
- **è‰²å½©**: [è‰²å½©å€¾å‘ï¼Œå¦‚æš–è‰²è°ƒé£Ÿæ¬²æ„Ÿç­‰]

### é£Ÿç‰©å‘ˆç°
- **æ‘†ç›˜**: [æ‘†ç›˜ç‰¹ç‚¹]
- **åˆ†é‡**: [è§†è§‰åˆ†é‡æ„Ÿ]
- **è´¨æ„Ÿ**: [é£Ÿç‰©è´¨æ„Ÿçš„å‘ˆç°]

## ğŸ’¡ å‚è€ƒä»·å€¼
### å®ç”¨ä¿¡æ¯
- **æ¨èç†ç”±**: [ä¸ºä»€ä¹ˆå€¼å¾—æ¨è/ä¸å€¼å¾—]
- **é€‚åˆåœºæ™¯**: [çº¦ä¼š/èšé¤/ä¸€äººé£Ÿ/å…¶ä»–]
- **æ³¨æ„äº‹é¡¹**: [ç‚¹é¤/åˆ¶ä½œæ—¶çš„æ³¨æ„äº‹é¡¹]

### å¯æ“ä½œæ€§
- **æ¢åº—**: [å®¹æ˜“æ‰¾åˆ°/éœ€è¦é¢„çº¦/å…¶ä»–]
- **åˆ¶ä½œ**: [éš¾åº¦é«˜/ä¸­/ä½]

## ğŸ“ ç¾é£Ÿé£æ ¼
- **å£å‘³åå¥½**: [ä½œè€…çš„å£å‘³å€¾å‘]
- **ç¾é£Ÿé£æ ¼**: [ç²¾è‡´/å®¶å¸¸/åˆ›æ„/ä¼ ç»Ÿ]
- **æ¨èæŒ‡æ•°**: [â˜…â˜…â˜…â˜…â˜…]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",

    'travel_guide': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œå†…å®¹åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„æ—…è¡Œæ”»ç•¥ç±»å›¾æ–‡ç¬”è®°ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **å†…å®¹ç±»å‹**: æ—…è¡Œæ”»ç•¥/æ™¯ç‚¹æ¨è
- **ç›®çš„åœ°**: [æ—…è¡Œç›®çš„åœ°]
- **æ—…è¡Œç±»å‹**: [å›½å†…æ¸¸/å‡ºå¢ƒæ¸¸/åŸå¸‚æ¼«æ­¥/è‡ªç„¶é£å…‰/äººæ–‡å†å²]
- **å†…å®¹å½¢å¼**: [å®Œæ•´æ”»ç•¥/æ™¯ç‚¹æ¨è/è¡Œç¨‹åˆ†äº«]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ100-200å­—ï¼‰
[æ¦‚æ‹¬æ—…è¡Œå†…å®¹çš„æ ¸å¿ƒä¿¡æ¯]

## ğŸ—ºï¸ ç›®çš„åœ°ä¿¡æ¯
### åŸºæœ¬ä¿¡æ¯
- **åœ°ç‚¹**: [å…·ä½“åœ°ç‚¹]
- **æœ€ä½³æ—¶é—´**: [ä»€ä¹ˆæ—¶å€™å»æœ€å¥½]
- **å»ºè®®æ—¶é•¿**: [å»ºè®®ç©å‡ å¤©]
- **é¢„ç®—ä¼°ç®—**: [é«˜/ä¸­/ä½]

### äº¤é€šä¿¡æ¯
- **å¦‚ä½•åˆ°è¾¾**: [äº¤é€šæ–¹å¼]
- **å½“åœ°äº¤é€š**: [å¦‚ä½•ç§»åŠ¨]

## ğŸ¯ æ™¯ç‚¹/ä½“éªŒåˆ†æ
### æ¨èæ™¯ç‚¹
[æåˆ°çš„æ™¯ç‚¹æˆ–ä½“éªŒ]
- **æ™¯ç‚¹1**: [åç§° + ç‰¹è‰² + æ¨èç†ç”±]
- **æ™¯ç‚¹2**: [åç§° + ç‰¹è‰² + æ¨èç†ç”±]
- **æ™¯ç‚¹3**: [åç§° + ç‰¹è‰² + æ¨èç†ç”±]

### è¡Œç¨‹å»ºè®®
[æ¨èçš„è¡Œç¨‹å®‰æ’]
- **Day1**: [ä¸»è¦å®‰æ’]
- **Day2**: [ä¸»è¦å®‰æ’]

## ğŸ“¸ è§†è§‰åˆ†æ
### å›¾ç‰‡é£æ ¼
- **æ‹æ‘„é£æ ¼**: [é£æ™¯/äººåƒ/çºªå®/æ‰“å¡]
- **æ„å›¾ç‰¹ç‚¹**: [æ„å›¾æ–¹å¼]
- **å…‰çº¿**: [æ‹æ‘„æ—¶å…‰çº¿ç‰¹ç‚¹]
- **å­£èŠ‚ç‰¹å¾**: [å›¾ç‰‡åæ˜ çš„å­£èŠ‚]

### è§†è§‰å¸å¼•åŠ›
- **ç”»é¢ç¾æ„Ÿ**: [â˜…â˜…â˜…â˜…â˜…]
- **çœŸå®åº¦**: [â˜…â˜…â˜…â˜…â˜…] - [æ˜¯å¦è¿‡åº¦ä¿®å›¾]
- **å‡ºç‰‡åº¦**: [â˜…â˜…â˜…â˜…â˜…] - [æ˜¯å¦å®¹æ˜“æ‹å‡ºå¥½çœ‹ç…§ç‰‡]

## ğŸ’¡ å®ç”¨å»ºè®®
### æ—…è¡Œè´´å£«
- **å¿…å¤‡ç‰©å“**: [åˆ—ä¸¾]
- **æ³¨æ„äº‹é¡¹**: [éœ€è¦æ³¨æ„ä»€ä¹ˆ]
- **é¿å‘æŒ‡å—**: [é¿å…å“ªäº›å‘]

### ä½å®¿/ç¾é£Ÿ
- **ä½å®¿å»ºè®®**: [ä½å®¿åŒºåŸŸæ¨è]
- **ç¾é£Ÿæ¨è**: [æ¨èç¾é£Ÿ]

## ğŸ“ æ”»ç•¥è´¨é‡
- **ä¿¡æ¯å®Œæ•´æ€§**: [é«˜/ä¸­/ä½]
- **å®ç”¨ä»·å€¼**: [é«˜/ä¸­/ä½]
- **åŸåˆ›æ€§**: [é«˜/ä¸­/ä½]

## ğŸ”— å»¶ä¼¸æ¨è
- **ç›¸ä¼¼ç›®çš„åœ°**: [æ¨èç±»ä¼¼çš„åœ°æ–¹]
- **æœ€ä½³æ­é…**: [å¯ä»¥ç»„åˆå»çš„å…¶ä»–åœ°æ–¹]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",

    'tech_review': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°ç äº§å“æµ‹è¯„å†…å®¹åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„æ•°ç æµ‹è¯„ç±»å›¾æ–‡ç¬”è®°ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **å†…å®¹ç±»å‹**: æ•°ç æµ‹è¯„/äº§å“è¯„æµ‹
- **äº§å“ç±»å‹**: [æ‰‹æœº/ç”µè„‘/è€³æœº/é…ä»¶/æ™ºèƒ½å®¶å±…/å…¶ä»–]
- **å†…å®¹å½¢å¼**: [å¼€ç®±/ä½¿ç”¨ä½“éªŒ/å¯¹æ¯”è¯„æµ‹/è´­ä¹°å»ºè®®]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ100-200å­—ï¼‰
[æ¦‚æ‹¬æµ‹è¯„å†…å®¹çš„æ ¸å¿ƒä¿¡æ¯]

## ğŸ“± äº§å“ä¿¡æ¯
### åŸºæœ¬ä¿¡æ¯
- **äº§å“åç§°**: [äº§å“å]
- **å‹å·**: [å…·ä½“å‹å·]
- **ä»·æ ¼**: [å‚è€ƒä»·æ ¼]
- **è´­ä¹°æ¸ é“**: [å¦‚æœèƒ½è¯†åˆ«]

### äº§å“ç‰¹ç‚¹
- **ä¸»è¦å–ç‚¹**: [åˆ—ä¸¾3-5ä¸ª]
- **ç›®æ ‡ç”¨æˆ·**: [é€‚åˆä»€ä¹ˆäººç¾¤]

## â­ æµ‹è¯„ç»´åº¦
### å¤–è§‚è®¾è®¡
- **è®¾è®¡é£æ ¼**: [ç®€çº¦/å•†åŠ¡/æ—¶å°š/å…¶ä»–]
- **åšå·¥è´¨æ„Ÿ**: [è¯„ä»·]
- **å°ºå¯¸é‡é‡**: [æè¿°]

### åŠŸèƒ½æ€§èƒ½
- **æ ¸å¿ƒåŠŸèƒ½**: [ä¸»è¦åŠŸèƒ½è¡¨ç°]
- **æ€§èƒ½è¡¨ç°**: [è¯„ä»·]
- **ä½¿ç”¨ä½“éªŒ**: [å®é™…ä½¿ç”¨æ„Ÿå—]

### ç»­èˆª/å…¶ä»–
- **ç»­èˆªèƒ½åŠ›**: [è¯„ä»·]
- **å……ç”µé€Ÿåº¦**: [è¯„ä»·]
- **ç‰¹è‰²åŠŸèƒ½**: [ç‹¬ç‰¹åŠŸèƒ½]

## ğŸ“Š ä¼˜ç¼ºç‚¹åˆ†æ
### ä¼˜ç‚¹
- **ä¼˜ç‚¹1**: [è¯´æ˜]
- **ä¼˜ç‚¹2**: [è¯´æ˜]
- **ä¼˜ç‚¹3**: [è¯´æ˜]

### ç¼ºç‚¹
- **ç¼ºç‚¹1**: [è¯´æ˜]
- **ç¼ºç‚¹2**: [è¯´æ˜]

### è¸©å‘ç‚¹
[è´­ä¹°æˆ–ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„çš„é—®é¢˜]

## ğŸ’° è´­ä¹°å»ºè®®
### æ¨èæŒ‡æ•°
- **ç»¼åˆè¯„åˆ†**: [â˜…â˜…â˜…â˜…â˜…]
- **æ¨èè´­ä¹°**: [æ˜¯/å¦/è§†æƒ…å†µ]

### é€‚åˆäººç¾¤
- **æ¨èäººç¾¤**: [åˆ—ä¸¾é€‚åˆçš„äººç¾¤]
- **ä¸æ¨è**: [ä¸é€‚åˆä»€ä¹ˆäºº]

### è´­ä¹°å»ºè®®
- **æœ€ä½³è´­ä¹°æ—¶æœº**: [ä¿ƒé”€/æ—¥å¸¸]
- **ç‰ˆæœ¬é€‰æ‹©**: [å“ªä¸ªç‰ˆæœ¬æœ€å€¼å¾—ä¹°]

## ğŸ“ æµ‹è¯„è´¨é‡
- **ä¸“ä¸šæ€§**: [é«˜/ä¸­/ä½]
- **å®¢è§‚æ€§**: [é«˜/ä¸­/ä½]
- **å®ç”¨æ€§**: [é«˜/ä¸­/ä½]

## ğŸ”— ç›¸å…³æ¨è
- **åŒç±»ç«å“**: [å€¼å¾—å¯¹æ¯”çš„å…¶ä»–äº§å“]
- **ç›¸å…³é…ä»¶**: [å€¼å¾—è´­ä¹°çš„é…ä»¶]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",

    'study_notes': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦ä¹ å¹²è´§å†…å®¹åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„å­¦ä¹ ç¬”è®°/å¹²è´§æ•™ç¨‹ç±»å›¾æ–‡ç¬”è®°ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **å†…å®¹ç±»å‹**: å­¦ä¹ ç¬”è®°/å¹²è´§æ•™ç¨‹
- **çŸ¥è¯†é¢†åŸŸ**: [å­¦ç§‘åˆ†ç±»/æŠ€èƒ½ç±»å‹]
- **å†…å®¹å½¢å¼**: [ç¬”è®°æ•´ç†/æ•™ç¨‹åˆ†äº«/æ–¹æ³•æ€»ç»“/æŠ€å·§æ¨è]
- **éš¾åº¦çº§åˆ«**: [å…¥é—¨/è¿›é˜¶/é«˜çº§]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ100-200å­—ï¼‰
[æ¦‚æ‹¬å­¦ä¹ å†…å®¹çš„è¦ç‚¹]

## ğŸ“š çŸ¥è¯†æå–
### æ ¸å¿ƒçŸ¥è¯†ç‚¹
[æå–ä¸»è¦çŸ¥è¯†ç‚¹]
- **çŸ¥è¯†ç‚¹1**: [è¯¦ç»†è¯´æ˜]
- **çŸ¥è¯†ç‚¹2**: [è¯¦ç»†è¯´æ˜]
- **çŸ¥è¯†ç‚¹3**: [è¯¦ç»†è¯´æ˜]

### æ–¹æ³•æŠ€å·§
[æå–çš„æ–¹æ³•å’ŒæŠ€å·§]
- **æ–¹æ³•1**: [è¯´æ˜ + ä½¿ç”¨åœºæ™¯]
- **æ–¹æ³•2**: [è¯´æ˜ + ä½¿ç”¨åœºæ™¯]

### é‡ç‚¹éš¾ç‚¹
- **é‡ç‚¹**: [éœ€è¦é‡ç‚¹æŒæ¡çš„å†…å®¹]
- **éš¾ç‚¹**: [å®¹æ˜“ç†è§£å›°éš¾çš„åœ°æ–¹]
- **æ˜“é”™ç‚¹**: [å®¹æ˜“çŠ¯é”™çš„åœ°æ–¹]

## ğŸ“ å­¦ä¹ ä»·å€¼
### å®ç”¨æ€§
- **çŸ¥è¯†ä»·å€¼**: [é«˜/ä¸­/ä½] - [è¯´æ˜]
- **å¯æ“ä½œæ€§**: [é«˜/ä¸­/ä½] - [è¯´æ˜]
- **æ–°é¢–æ€§**: [â˜…â˜…â˜…â˜…â˜…]

### é€‚ç”¨äººç¾¤
- **ç›®æ ‡å—ä¼—**: [é€‚åˆä»€ä¹ˆäººå­¦ä¹ ]
- **å‰ç½®è¦æ±‚**: [éœ€è¦ä»€ä¹ˆåŸºç¡€]
- **åº”ç”¨åœºæ™¯**: [åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨]

## ğŸ“ å†…å®¹è´¨é‡åˆ†æ
### ç»“æ„æ€§
- **é€»è¾‘æ¸…æ™°**: [æ˜¯/å¦] - [è¯„ä»·]
- **å±‚æ¬¡åˆ†æ˜**: [æ˜¯/å¦] - [è¯„ä»·]
- **å®Œæ•´æ€§**: [ä¿¡æ¯æ˜¯å¦å®Œæ•´]

### è¡¨è¾¾æ–¹å¼
- **å‘ˆç°å½¢å¼**: [æ–‡å­—/å›¾ç¤º/è¡¨æ ¼/æµç¨‹å›¾]
- **è®²è§£é£æ ¼**: [ç®€æ´/è¯¦ç»†/ç”ŸåŠ¨/æ¯ç‡¥]
- **æ˜“æ‡‚ç¨‹åº¦**: [é«˜/ä¸­/ä½]

## ğŸ’¡ å­¦ä¹ å»ºè®®
### å­¦ä¹ è·¯å¾„
[å¦‚ä½•å­¦ä¹ è¿™äº›å†…å®¹]
- **Step1**: [ç¬¬ä¸€é˜¶æ®µ]
- **Step2**: [ç¬¬äºŒé˜¶æ®µ]
- **Step3**: [ç¬¬ä¸‰é˜¶æ®µ]

### é…å¥—èµ„æº
[æ˜¯å¦æåˆ°é…å¥—èµ„æº]
- **æ¨èå·¥å…·**: [ç›¸å…³çš„å·¥å…·æˆ–è½¯ä»¶]
- **å»¶ä¼¸é˜…è¯»**: [å€¼å¾—æ·±å…¥äº†è§£çš„èµ„æ–™]

## ğŸ¯ è¡ŒåŠ¨æŒ‡å—
### ç«‹å³å¯ç”¨
[å­¦å®Œå¯ä»¥ç«‹å³åº”ç”¨çš„ç‚¹]
- **åº”ç”¨1**: [è¯´æ˜]
- **åº”ç”¨2**: [è¯´æ˜]

### é•¿æœŸä»·å€¼
[å†…å®¹çš„é•¿æœŸä»·å€¼]
- **çŸ¥è¯†ä½“ç³»**: [åœ¨çŸ¥è¯†ä½“ç³»ä¸­çš„ä½ç½®]
- **å¯å¤ç”¨æ€§**: [é«˜/ä¸­/ä½]

## ğŸ”— å»¶ä¼¸å­¦ä¹ 
- **è¿›é˜¶æ–¹å‘**: [å¯ä»¥æ·±å…¥å­¦ä¹ çš„æ–¹å‘]
- **ç›¸å…³ä¸»é¢˜**: [ç›¸å…³çš„å­¦ä¹ ä¸»é¢˜]
- **æ¨èèµ„æº**: [å€¼å¾—å…³æ³¨çš„èµ„æº]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",

    'general': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å°çº¢ä¹¦å›¾æ–‡ç¬”è®°åˆ†æå¸ˆã€‚è¯·è¯¦ç»†åˆ†æè¿™ç»„å›¾æ–‡ç¬”è®°ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ğŸ“‹ ç¬”è®°åŸºæœ¬ä¿¡æ¯
- **ç¬”è®°ç±»å‹**: [æ ¹æ®å†…å®¹åˆ¤æ–­ç±»å‹]
- **æ ¸å¿ƒä¸»é¢˜**: [ä¸€å¥è¯æ¦‚æ‹¬]
- **å†…å®¹é£æ ¼**: [æè¿°å†…å®¹é£æ ¼]

## ğŸ“– å†…å®¹æ¦‚è¦ï¼ˆ150-250å­—ï¼‰
[ç»“åˆå›¾ç‰‡å’Œæ–‡å­—ï¼Œç”¨ç²¾ç‚¼çš„è¯­è¨€æ¦‚æ‹¬ç¬”è®°æ ¸å¿ƒå†…å®¹]

## ğŸ¯ æ ¸å¿ƒä¿¡æ¯æå–
### ä¸»è¦å†…å®¹
[åˆ—ä¸¾ä¸»è¦å†…å®¹è¦ç‚¹]
- è¦ç‚¹1: [è¯¦ç»†è¯´æ˜]
- è¦ç‚¹2: [è¯¦ç»†è¯´æ˜]
- è¦ç‚¹3: [è¯¦ç»†è¯´æ˜]

### å…³é”®ç»†èŠ‚
[å€¼å¾—å…³æ³¨çš„å…³é”®ä¿¡æ¯]

## ğŸ“¸ è§†è§‰åˆ†æ
### å›¾ç‰‡ç‰¹ç‚¹
- **å›¾ç‰‡æ•°é‡**: [å›¾ç‰‡æ•°é‡]å¼ 
- **å›¾ç‰‡é£æ ¼**: [æè¿°å›¾ç‰‡é£æ ¼]
- **è§†è§‰æ•ˆæœ**: [æ•´ä½“è§†è§‰æ•ˆæœ]

### å†…å®¹å‘ˆç°
- **å›¾æ–‡é…åˆ**: [å›¾æ–‡å¦‚ä½•é…åˆ]
- **æ’ç‰ˆç‰¹ç‚¹**: [æ’ç‰ˆç‰¹ç‚¹]

## ğŸ’¡ äº®ç‚¹ä¸ä»·å€¼
### å†…å®¹äº®ç‚¹
[è¿™ç¯‡ç¬”è®°çš„äº®ç‚¹]
- äº®ç‚¹1: [...]
- äº®ç‚¹2: [...]

### ä»·å€¼è¯„ä¼°
- **å®ç”¨æ€§**: [é«˜/ä¸­/ä½] - [è¯´æ˜]
- **æ–°é¢–æ€§**: [é«˜/ä¸­/ä½] - [è¯´æ˜]
- **å¯æ“ä½œæ€§**: [é«˜/ä¸­/ä½] - [è¯´æ˜]

## ğŸ“ ä½œè€…é£æ ¼åˆ†æ
- **è¡¨è¾¾æ–¹å¼**: [æè¿°è¡¨è¾¾æ–¹å¼]
- **å†…å®¹å€¾å‘**: [æè¿°å†…å®¹å€¾å‘]
- **ç‰¹è‰²æ ‡ç­¾**: [ç›¸å…³æ ‡ç­¾]

## âš ï¸ æ³¨æ„äº‹é¡¹
[éœ€è¦ç•™æ„çš„ç‚¹]

## ğŸ”— ç›¸å…³å»¶ä¼¸
[å€¼å¾—äº†è§£çš„ç›¸å…³å†…å®¹]

---

## åŸå§‹æ–‡æ¡ˆå†…å®¹:

{text}

---

è¯·ç¡®ä¿è¾“å‡ºç»“æ„å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å®è´¨å†…å®¹ã€‚""",
}

# é£æ ¼è‡ªåŠ¨è¯†åˆ«æç¤ºè¯
STYLE_DETECTION_PROMPT = """è¯·åˆ†æä»¥ä¸‹å›¾æ–‡ç¬”è®°çš„å†…å®¹ï¼Œåˆ¤æ–­å®ƒå±äºå“ªç§å†…å®¹é£æ ¼ç±»å‹ã€‚

å¯é€‰çš„é£æ ¼ç±»å‹ï¼š
1. **life_vlog** - ç”Ÿæ´»è®°å½•/æ—¥å¸¸åˆ†äº«ï¼šè®°å½•æ—¥å¸¸ç”Ÿæ´»ã€å¿ƒæƒ…ã€éšæƒ³
2. **quote_wisdom** - çº¯æ–‡å­—/é‡‘å¥/äººç”Ÿé“ç†ï¼šä»¥æ–‡å­—ä¸ºä¸»ï¼Œåˆ†äº«äººç”Ÿæ„Ÿæ‚Ÿã€é“ç†
3. **news_info** - æ–°é—»èµ„è®¯/çŸ¥è¯†ç§‘æ™®ï¼šåˆ†äº«æ–°é—»äº‹ä»¶ã€ç§‘æ™®çŸ¥è¯†ã€è¡Œä¸šåŠ¨æ€
4. **fashion_look** - ç©¿æ­/ç¾å¦†/é¢œå€¼åˆ†äº«ï¼šæœè£…æ­é…ã€ç¾å¦†æ•™ç¨‹
5. **food_review** - ç¾é£Ÿæ¢åº—/é£Ÿè°±åˆ†äº«ï¼šé¤å…æ¢åº—ã€ç¾é£Ÿåˆ¶ä½œ
6. **travel_guide** - æ—…è¡Œæ”»ç•¥/æ™¯ç‚¹æ¨èï¼šæ—…è¡Œæ”»ç•¥ã€æ™¯ç‚¹æ¨è
7. **tech_review** - æ•°ç æµ‹è¯„/äº§å“è¯„æµ‹ï¼šæ•°ç äº§å“æµ‹è¯„ã€å¼€ç®±
8. **study_notes** - å­¦ä¹ ç¬”è®°/å¹²è´§æ•™ç¨‹ï¼šå­¦ä¹ ç¬”è®°ã€æ•™ç¨‹ã€å¹²è´§åˆ†äº«

è¯·ä»”ç»†åˆ†æå›¾ç‰‡å†…å®¹å’Œæ–‡å­—æè¿°ï¼Œé€‰æ‹©æœ€åŒ¹é…çš„ä¸€ä¸ªé£æ ¼ç±»å‹ã€‚

## æ–‡å­—å†…å®¹:
{text}

## å›¾ç‰‡æè¿°:
[è¯·è§‚å¯Ÿå›¾ç‰‡å†…å®¹ï¼Œæè¿°å›¾ç‰‡å±•ç¤ºçš„æ˜¯ä»€ä¹ˆç±»å‹çš„å†…å®¹]

è¯·ç›´æ¥è¾“å‡ºé£æ ¼ç±»å‹çš„è‹±æ–‡åç§°ï¼ˆå¦‚ life_vlogã€quote_wisdom ç­‰ï¼‰ï¼Œä¸è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚
åªè¾“å‡ºä¸€ä¸ªæœ€åŒ¹é…çš„é£æ ¼ç±»å‹ã€‚"""


# ==================== API é…ç½® ====================

def get_api_key() -> str:
    """è·å– Gemini API Key"""
    api_key = os.environ.get('GEMINI_API_KEY')
    if api_key:
        return api_key

    try:
        sys.path.insert(0, str(Path(__file__).parent.parent))
        from config_api import API_CONFIG
        api_key = API_CONFIG.get('gemini', {}).get('api_key')
        if api_key:
            return api_key
    except ImportError:
        pass

    return None


def configure_gemini(api_key: str = None) -> bool:
    """é…ç½® Gemini API"""
    if not api_key:
        api_key = get_api_key()

    if not api_key:
        print("âŒ æœªæ‰¾åˆ° Gemini API Key")
        print("\nè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€é…ç½® API Key:")
        print("1. è®¾ç½®ç¯å¢ƒå˜é‡: export GEMINI_API_KEY='your-key'")
        print("2. åœ¨ config_api.py ä¸­æ·»åŠ :")
        print('   API_CONFIG = {"gemini": {"api_key": "your-key"}}')
        return False

    try:
        genai.configure(api_key=api_key)
        return True
    except Exception as e:
        print(f"âŒ Gemini API é…ç½®å¤±è´¥: {e}")
        return False


# ==================== åˆ†æå™¨ ====================

class XHSImageAnalyzer:
    """å°çº¢ä¹¦å›¾æ–‡åˆ†æå™¨"""

    def __init__(self, model: str = 'flash-lite', api_key: str = None):
        self.api_key = api_key or get_api_key()
        self.model_name = GEMINI_MODELS.get(model, GEMINI_MODELS['flash'])
        self.model = model

        if not configure_gemini(self.api_key):
            raise ValueError("æ— æ³•é…ç½® Gemini API")

    def detect_style(self, text: str, image_files: List = None) -> str:
        """
        è‡ªåŠ¨æ£€æµ‹å†…å®¹é£æ ¼ç±»å‹

        Args:
            text: æ–‡å­—å†…å®¹
            image_files: å·²ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶å¯¹è±¡ï¼ˆå¯é€‰ï¼‰

        Returns:
            æ£€æµ‹åˆ°çš„é£æ ¼ç±»å‹
        """
        print(f"ğŸ” è‡ªåŠ¨æ£€æµ‹å†…å®¹é£æ ¼...")

        # å…ˆç”¨å…³é”®è¯å¿«é€Ÿæ£€æµ‹
        text_lower = text.lower()
        for style_key, style_info in CONTENT_STYLES.items():
            for keyword in style_info['keywords']:
                if keyword in text:
                    print(f"   â””â”€ æ£€æµ‹åˆ°å…³é”®è¯ '{keyword}' -> {style_info['name']}")
                    return style_key

        # å¦‚æœå…³é”®è¯æ²¡æ£€æµ‹åˆ°ï¼Œç”¨ AI åˆ†æ
        if image_files:
            try:
                model = genai.GenerativeModel(self.model_name)
                contents = image_files + [STYLE_DETECTION_PROMPT.format(text=text)]

                response = model.generate_content(contents)
                detected_style = response.text.strip().lower()

                # éªŒè¯è¿”å›çš„é£æ ¼æ˜¯å¦æœ‰æ•ˆ
                if detected_style in CONTENT_STYLES:
                    print(f"   â””â”€ AI æ£€æµ‹ -> {CONTENT_STYLES[detected_style]['name']}")
                    return detected_style
            except Exception as e:
                print(f"   â””â”€ âš ï¸ AI æ£€æµ‹å¤±è´¥: {e}")

        # é»˜è®¤è¿”å›é€šç”¨ç±»å‹
        print(f"   â””â”€ ä½¿ç”¨é»˜è®¤é£æ ¼ -> é€šç”¨åˆ†æ")
        return 'general'

    def upload_images(self, image_paths: List[Path]) -> List:
        """ä¸Šä¼ å›¾ç‰‡åˆ° Gemini Files API"""
        uploaded_files = []

        print(f"\nğŸ“¤ ä¸Šä¼ å›¾ç‰‡åˆ° Gemini...")
        print(f"{'='*60}")

        for i, img_path in enumerate(image_paths, 1):
            print(f"[{i}/{len(image_paths)}] {img_path.name}... ", end='', flush=True)

            try:
                img_file = genai.upload_file(
                    path=str(img_path),
                    display_name=img_path.name
                )

                # ç­‰å¾…å¤„ç†å®Œæˆ
                while img_file.state.name == "PROCESSING":
                    time.sleep(1)
                    img_file = genai.get_file(img_file.name)

                if img_file.state.name == "ACTIVE":
                    size_mb = img_path.stat().st_size / (1024 * 1024)
                    print(f"âœ… ({size_mb:.2f}MB)")
                    uploaded_files.append(img_file)
                else:
                    print(f"âŒ çŠ¶æ€: {img_file.state.name}")

            except Exception as e:
                print(f"âŒ {e}")

        print(f"{'='*60}")
        print(f"âœ… æˆåŠŸä¸Šä¼  {len(uploaded_files)}/{len(image_paths)} å¼ å›¾ç‰‡\n")

        return uploaded_files

    def analyze_note(self, text: str, image_files: List,
                     style: str = 'general') -> Tuple[str, dict]:
        """
        å›¾æ–‡æ··åˆåˆ†æ

        Args:
            text: ç¬”è®°æ–‡å­—å†…å®¹
            image_files: ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶å¯¹è±¡åˆ—è¡¨
            style: å†…å®¹é£æ ¼ç±»å‹

        Returns:
            (åˆ†æç»“æœ, tokenä¿¡æ¯)
        """
        prompt = STYLE_PROMPTS.get(style, STYLE_PROMPTS['general']).format(text=text)

        print(f"ğŸ¤– ä½¿ç”¨æ¨¡å‹: {self.model_name}")
        print(f"ğŸ“ åˆ†æé£æ ¼: {CONTENT_STYLES.get(style, {}).get('name', style)}")
        print(f"{'='*60}")

        try:
            model = genai.GenerativeModel(self.model_name)
            contents = image_files + [prompt]

            print(f"ğŸ”„ æ­£åœ¨åˆ†æ...")
            start_time = time.time()

            response = model.generate_content(contents)

            elapsed = time.time() - start_time
            print(f"âœ… åˆ†æå®Œæˆ! ({elapsed:.1f}ç§’)\n")

            # æå– token ä½¿ç”¨ä¿¡æ¯
            token_info = {
                'prompt_tokens': 0,
                'candidates_tokens': 0,
                'total_tokens': 0
            }

            if hasattr(response, 'usage_metadata') and response.usage_metadata:
                token_info['prompt_tokens'] = response.usage_metadata.prompt_token_count or 0
                token_info['candidates_tokens'] = response.usage_metadata.candidates_token_count or 0
                token_info['total_tokens'] = response.usage_metadata.total_token_count or 0

            return response.text, token_info

        except Exception as e:
            error_msg = f"âŒ åˆ†æå¤±è´¥: {e}"
            print(error_msg)
            return error_msg, {}

    def delete_files(self, files: List):
        """åˆ é™¤å·²ä¸Šä¼ çš„æ–‡ä»¶"""
        for f in files:
            try:
                genai.delete_file(f.name)
            except:
                pass


# ==================== è¾“å‡ºç®¡ç† ====================

def save_result(title: str, username: str, text: str, result: str,
                style: str, model: str, token_info: dict, image_count: int,
                image_dir: str, output_dir: str = "xhs_analysis") -> Path:
    """ä¿å­˜åˆ†æç»“æœ"""
    output_path = Path(output_dir)

    # ä¿æŒç”¨æˆ·åæ–‡ä»¶å¤¹ç»“æ„
    safe_username = re.sub(r'[<>:"/\\|?*]', '_', username)[:30]
    user_output = output_path / safe_username
    user_output.mkdir(parents=True, exist_ok=True)

    # æ¸…ç†æ ‡é¢˜ä½œä¸ºæ–‡ä»¶å
    safe_title = re.sub(r'[<>:"/\\|?*]', '_', title)[:50]
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')

    result_file = user_output / f"{safe_title}_{timestamp}.md"

    with open(result_file, 'w', encoding='utf-8') as f:
        f.write(f"# {title}\n\n")
        f.write(f"## ğŸ“Œ å…ƒä¿¡æ¯\n\n")
        f.write(f"| é¡¹ç›® | å†…å®¹ |\n")
        f.write(f"|------|------|\n")
        f.write(f"| **ä½œè€…** | {username} |\n")
        f.write(f"| **ç¬”è®°æ ‡é¢˜** | {title} |\n")
        f.write(f"| **åˆ†ææ—¶é—´** | {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} |\n")
        f.write(f"| **ä½¿ç”¨æ¨¡å‹** | {model} |\n")
        f.write(f"| **å†…å®¹é£æ ¼** | {CONTENT_STYLES.get(style, {}).get('name', style)} |\n")
        f.write(f"| **å›¾ç‰‡æ•°é‡** | {image_count} |\n")
        f.write(f"| **æ¥æºç›®å½•** | `{image_dir}` |\n")

        if token_info and token_info.get('total_tokens', 0) > 0:
            f.write(f"| **Token ä½¿ç”¨** | è¾“å…¥: {token_info.get('prompt_tokens', 0):,} | è¾“å‡º: {token_info.get('candidates_tokens', 0):,} | **æ€»è®¡: {token_info.get('total_tokens', 0):,}** |\n")

        f.write(f"\n---\n\n")
        f.write(f"## ğŸ“„ åŸå§‹æ–‡å­—å†…å®¹\n\n")
        f.write(f"{text}\n\n")
        f.write(f"---\n\n")
        f.write(f"## ğŸ¤– AI åˆ†æç»“æœ\n\n")
        f.write(result)

    return result_file


def load_text_content(image_dir: Path, text_file: str = None) -> Tuple[str, str]:
    """
    ä»ç›®å½•åŠ è½½æ–‡å­—å†…å®¹

    Args:
        image_dir: å›¾ç‰‡ç›®å½•
        text_file: æŒ‡å®šçš„æ–‡å­—æ–‡ä»¶å

    Returns:
        (ç”¨æˆ·å, æ–‡å­—å†…å®¹)
    """
    # å°è¯•è¯»å– content.txt
    if text_file:
        text_path = image_dir / text_file
    else:
        text_path = image_dir / "content.txt"

    username = "æœªçŸ¥ç”¨æˆ·"
    text_content = ""

    if text_path.exists():
        with open(text_path, 'r', encoding='utf-8') as f:
            content = f.read()

        # å°è¯•æå–ç”¨æˆ·åï¼ˆä»ç›®å½•åï¼‰
        username = image_dir.parent.name

        # æå–çº¯æ–‡æ¡ˆå†…å®¹
        lines = content.split('\n')
        content_lines = []
        in_content = False
        for line in lines:
            if 'æ–‡æ¡ˆ:' in line or 'desc:' in line.lower():
                in_content = True
                continue
            if in_content:
                content_lines.append(line)

        text_content = '\n'.join(content_lines).strip()

        # å¦‚æœæ²¡æœ‰æå–åˆ°ï¼Œä½¿ç”¨å…¨éƒ¨å†…å®¹
        if not text_content:
            text_content = content

    return username, text_content


def get_image_files(image_dir: Path) -> List[Path]:
    """è·å–ç›®å½•ä¸­çš„æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶"""
    image_extensions = ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.bmp']
    image_paths = set()  # ä½¿ç”¨ set è‡ªåŠ¨å»é‡

    for ext in image_extensions:
        # Windows ä¸åŒºåˆ†å¤§å°å†™ï¼Œåªæœç´¢å°å†™å³å¯
        image_paths.update(image_dir.glob(f"*{ext}"))

    return sorted(image_paths)


def process_single_note(image_dir: str, analyzer: XHSImageAnalyzer,
                        style: str = None, auto_style: bool = True,
                        text_file: str = None, output_dir: str = "xhs_analysis") -> bool:
    """
    å¤„ç†å•ä¸ªç¬”è®°ç›®å½•

    Args:
        image_dir: å›¾ç‰‡ç›®å½•è·¯å¾„
        analyzer: åˆ†æå™¨å®ä¾‹
        style: æŒ‡å®šçš„é£æ ¼ç±»å‹
        auto_style: æ˜¯å¦è‡ªåŠ¨æ£€æµ‹é£æ ¼
        text_file: æ–‡å­—æ–‡ä»¶å
        output_dir: è¾“å‡ºç›®å½•

    Returns:
        æ˜¯å¦æˆåŠŸ
    """
    image_dir = Path(image_dir)

    if not image_dir.is_dir():
        print(f"âŒ ç›®å½•ä¸å­˜åœ¨: {image_dir}")
        return False

    # è·å–å›¾ç‰‡æ–‡ä»¶
    image_paths = get_image_files(image_dir)

    if not image_paths:
        print(f"âŒ æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶")
        return False

    print(f"\n{'='*80}")
    # å°è¯•æ˜¾ç¤ºç›¸å¯¹è·¯å¾„ï¼Œå¦‚æœå¤±è´¥åˆ™æ˜¾ç¤ºç»å¯¹è·¯å¾„
    try:
        display_path = image_dir.relative_to(Path.cwd())
    except ValueError:
        display_path = image_dir
    print(f"ğŸ“ ç¬”è®°ç›®å½•: {display_path}")
    print(f"ğŸ‘¤ ä½œè€…: {image_dir.parent.name}")
    print(f"ğŸ“ æ ‡é¢˜: {image_dir.name}")
    print(f"ğŸ“¸ å›¾ç‰‡æ•°é‡: {len(image_paths)}")
    print(f"{'='*80}")

    # åŠ è½½æ–‡å­—å†…å®¹
    username, text_content = load_text_content(image_dir, text_file)
    print(f"ğŸ“„ æ–‡å­—å†…å®¹: {len(text_content)} å­—ç¬¦")

    # ä¸Šä¼ å›¾ç‰‡
    uploaded_files = analyzer.upload_images(image_paths)

    if not uploaded_files:
        print(f"âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥")
        return False

    try:
        # æ£€æµ‹é£æ ¼
        detected_style = style
        if auto_style and not style:
            detected_style = analyzer.detect_style(text_content, uploaded_files)
        elif style:
            print(f"ğŸ¨ æŒ‡å®šé£æ ¼: {CONTENT_STYLES.get(style, {}).get('name', style)}")

        # åˆ†æå›¾æ–‡
        result, token_info = analyzer.analyze_note(
            text=text_content,
            image_files=uploaded_files,
            style=detected_style or 'general'
        )

        # åˆ é™¤ä¸Šä¼ çš„æ–‡ä»¶
        analyzer.delete_files(uploaded_files)

        # ä¿å­˜ç»“æœ
        if result and not result.startswith("âŒ"):
            # ä¿å­˜å›¾ç‰‡ç›®å½•çš„ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚æœå¯èƒ½ï¼‰
            try:
                image_dir_rel = str(image_dir.relative_to(Path.cwd()))
            except ValueError:
                image_dir_rel = str(image_dir)

            result_file = save_result(
                title=image_dir.name,
                username=username,
                text=text_content,
                result=result,
                style=detected_style or 'general',
                model=analyzer.model_name,
                token_info=token_info,
                image_count=len(uploaded_files),
                image_dir=image_dir_rel,
                output_dir=output_dir
            )

            # å°è¯•æ˜¾ç¤ºç›¸å¯¹è·¯å¾„
            try:
                print(f"ğŸ’¾ ç»“æœå·²ä¿å­˜: {result_file.relative_to(Path.cwd())}")
            except ValueError:
                print(f"ğŸ’¾ ç»“æœå·²ä¿å­˜: {result_file}")

            if token_info and token_info.get('total_tokens', 0) > 0:
                print(f"ğŸ“Š Token ä½¿ç”¨: è¾“å…¥ {token_info.get('prompt_tokens', 0):,} | è¾“å‡º {token_info.get('candidates_tokens', 0):,} | æ€»è®¡ {token_info.get('total_tokens', 0):,}")

            return True
        else:
            print(f"âŒ åˆ†æå¤±è´¥")
            return False

    except Exception as e:
        print(f"âŒ å¤„ç†å¤±è´¥: {e}")
        return False


def batch_process_user(user_dir: str, analyzer: XHSImageAnalyzer,
                       style: str = None, auto_style: bool = True,
                       output_dir: str = "xhs_analysis") -> Dict[str, int]:
    """
    æ‰¹é‡å¤„ç†ç”¨æˆ·çš„æ‰€æœ‰ç¬”è®°

    Args:
        user_dir: ç”¨æˆ·ç›®å½•ï¼ˆåŒ…å«å¤šä¸ªç¬”è®°å­ç›®å½•ï¼‰
        analyzer: åˆ†æå™¨å®ä¾‹
        style: æŒ‡å®šçš„é£æ ¼ç±»å‹
        auto_style: æ˜¯å¦è‡ªåŠ¨æ£€æµ‹é£æ ¼
        output_dir: è¾“å‡ºç›®å½•

    Returns:
        ç»Ÿè®¡ä¿¡æ¯å­—å…¸
    """
    user_path = Path(user_dir)

    if not user_path.is_dir():
        print(f"âŒ ç›®å½•ä¸å­˜åœ¨: {user_dir}")
        return {'total': 0, 'success': 0, 'fail': 0}

    # æŸ¥æ‰¾æ‰€æœ‰ç¬”è®°ç›®å½•ï¼ˆåŒ…å«å›¾ç‰‡æ–‡ä»¶çš„å­ç›®å½•ï¼‰
    note_dirs = []
    for item in user_path.iterdir():
        if item.is_dir():
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡æ–‡ä»¶
            if get_image_files(item):
                note_dirs.append(item)

    if not note_dirs:
        print(f"âŒ æœªæ‰¾åˆ°åŒ…å«å›¾ç‰‡çš„ç¬”è®°ç›®å½•")
        return {'total': 0, 'success': 0, 'fail': 0}

    print(f"\n{'='*80}")
    print(f"ğŸ‘¤ ç”¨æˆ·: {user_path.name}")
    print(f"ğŸ“Š æ‰¾åˆ° {len(note_dirs)} ä¸ªç¬”è®°")
    print(f"{'='*80}")

    stats = {'total': len(note_dirs), 'success': 0, 'fail': 0}

    for i, note_dir in enumerate(note_dirs, 1):
        print(f"\n\n{'#'*80}")
        print(f"# [{i}/{len(note_dirs)}] å¤„ç†ç¬”è®°: {note_dir.name}")
        print(f"{'#'*80}")

        if process_single_note(note_dir, analyzer, style, auto_style, None, output_dir):
            stats['success'] += 1
        else:
            stats['fail'] += 1

        # é¿å…è¯·æ±‚è¿‡å¿«
        time.sleep(2)

    print(f"\n\n{'='*80}")
    print(f"ğŸ“Š æ‰¹é‡å¤„ç†å®Œæˆ")
    print(f"{'='*80}")
    print(f"ç”¨æˆ·: {user_path.name}")
    print(f"æ€»è®¡: {stats['total']} | æˆåŠŸ: {stats['success']} | å¤±è´¥: {stats['fail']}")

    return stats


# ==================== ä¸»ç¨‹åº ====================

def main():
    import argparse

    parser = argparse.ArgumentParser(
        description="å°çº¢ä¹¦å›¾æ–‡ç¬”è®°åˆ†æå·¥å…·",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ç¤ºä¾‹:

1. åˆ†æå•ä¸ªç¬”è®°ï¼ˆè‡ªåŠ¨æ£€æµ‹é£æ ¼ï¼‰:
   python xhs_image_analysis.py --dir "xhs_images/ç”¨æˆ·å/ç¬”è®°æ ‡é¢˜"

2. æŒ‡å®šå†…å®¹é£æ ¼:
   python xhs_image_analysis.py --dir "images" --style quote_wisdom

3. æ‰¹é‡åˆ†æç”¨æˆ·çš„æ‰€æœ‰ç¬”è®°:
   python xhs_image_analysis.py --user-dir "xhs_images/å¡‘æ–™å‰FOKU"

4. è¯»å–æŒ‡å®šæ–‡æ¡ˆæ–‡ä»¶:
   python xhs_image_analysis.py --dir "images" --text-file "my_content.txt"

5. ä½¿ç”¨ä¸åŒçš„æ¨¡å‹:
   python xhs_image_analysis.py --dir "images" --model flash
        """
    )

    parser.add_argument('--dir', help='å•ä¸ªç¬”è®°çš„å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„')
    parser.add_argument('--user-dir', help='ç”¨æˆ·æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆæ‰¹é‡å¤„ç†è¯¥ç”¨æˆ·çš„æ‰€æœ‰ç¬”è®°ï¼‰')
    parser.add_argument('--style', choices=list(CONTENT_STYLES.keys()),
                        help='æŒ‡å®šå†…å®¹é£æ ¼ç±»å‹')
    parser.add_argument('--auto-style', action='store_true', default=True,
                        help='è‡ªåŠ¨æ£€æµ‹å†…å®¹é£æ ¼ï¼ˆé»˜è®¤å¯ç”¨ï¼‰')
    parser.add_argument('--no-auto-style', action='store_false', dest='auto_style',
                        help='ç¦ç”¨è‡ªåŠ¨é£æ ¼æ£€æµ‹ï¼Œä½¿ç”¨é€šç”¨åˆ†æ')
    parser.add_argument('--text-file', help='æŒ‡å®šæ–‡æ¡ˆæ–‡ä»¶åï¼ˆé»˜è®¤ä¸º content.txtï¼‰')
    parser.add_argument('--model', choices=['flash', 'flash-lite', 'pro'],
                        default='flash-lite', help='Gemini æ¨¡å‹ï¼ˆé»˜è®¤: flash-liteï¼‰')
    parser.add_argument('-o', '--output', default='xhs_analysis',
                        help='è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤: xhs_analysisï¼‰')
    parser.add_argument('--api-key', help='Gemini API Keyï¼ˆè¦†ç›–é…ç½®æ–‡ä»¶ï¼‰')
    parser.add_argument('--list-styles', action='store_true',
                        help='åˆ—å‡ºæ‰€æœ‰æ”¯æŒçš„å†…å®¹é£æ ¼ç±»å‹')

    args = parser.parse_args()

    # åˆ—å‡ºé£æ ¼ç±»å‹
    if args.list_styles:
        print("\nğŸ“‹ æ”¯æŒçš„å†…å®¹é£æ ¼ç±»å‹:\n")
        for key, info in CONTENT_STYLES.items():
            print(f"   {key:15} - {info['name']}")
            print(f"{'':15}    å…³é”®è¯: {', '.join(info['keywords'])}")
            print(f"{'':15}    æè¿°: {info['description']}\n")
        return

    # æ£€æŸ¥å‚æ•°
    if not args.dir and not args.user_dir:
        parser.print_help()
        return

    # åˆå§‹åŒ–åˆ†æå™¨
    try:
        analyzer = XHSImageAnalyzer(model=args.model, api_key=args.api_key)
    except ValueError as e:
        print(f"âŒ {e}")
        return

    print(f"\n{'='*80}")
    print(f"ğŸ–¼ï¸  å°çº¢ä¹¦å›¾æ–‡ç¬”è®°åˆ†æå·¥å…·")
    print(f"{'='*80}")

    # å¤„ç†å•ä¸ªç¬”è®°
    if args.dir:
        success = process_single_note(
            image_dir=args.dir,
            analyzer=analyzer,
            style=args.style,
            auto_style=args.auto_style,
            text_file=args.text_file,
            output_dir=args.output
        )

        if success:
            print(f"\nâœ… å®Œæˆ!")
        else:
            print(f"\nâŒ å¤±è´¥!")

    # æ‰¹é‡å¤„ç†ç”¨æˆ·ç¬”è®°
    elif args.user_dir:
        stats = batch_process_user(
            user_dir=args.user_dir,
            analyzer=analyzer,
            style=args.style,
            auto_style=args.auto_style,
            output_dir=args.output
        )

        if stats['success'] > 0:
            print(f"\nâœ… å®Œæˆ!")
        else:
            print(f"\nâŒ å…¨éƒ¨å¤±è´¥!")


if __name__ == "__main__":
    main()
