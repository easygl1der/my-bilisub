#!/usr/bin/env python3
"""
小红书图文笔记分析工具

功能：
1. 从本地图片文件夹分析小红书图文笔记
2. 自动识别内容风格类型
3. 针对不同风格使用专门的分析提示词
4. 输出结构化的知识库笔记

支持的内容风格类型：
- life_vlog: 生活记录/日常分享
- quote_wisdom: 纯文字/金句/人生道理
- news_info: 新闻资讯/知识科普
- fashion_look: 穿搭/美妆/颜值分享
- food_review: 美食探店/食谱分享
- travel_guide: 旅行攻略/景点推荐
- tech_review: 数码测评/产品评测
- study_notes: 学习笔记/干货教程

使用示例:
    # 分析本地图片文件夹
    python xhs_image_analysis.py --dir "xhs_images/用户名/笔记标题"

    # 指定内容风格
    python xhs_image_analysis.py --dir "images" --style quote_wisdom

    # 自动识别风格（默认）
    python xhs_image_analysis.py --dir "images" --auto-style

    # 批量分析用户的所有笔记
    python xhs_image_analysis.py --user-dir "xhs_images/塑料叉FOKU"

    # 读取文案文件
    python xhs_image_analysis.py --dir "images" --text-file "content.txt"
"""

import os
import sys
import time
import json
import re
import hashlib
import requests
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Optional, Tuple

# Windows编码修复
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

# 忽略所有 FutureWarning
import warnings
warnings.filterwarnings("ignore", category=FutureWarning)

try:
    import google.generativeai as genai
    GENAI_AVAILABLE = True
except ImportError:
    print("❌ 未安装 google-generativeai 库")
    print("请运行: pip install google-generativeai")
    sys.exit(1)


# ==================== 配置 ====================

GEMINI_MODELS = {
    'flash-lite': 'gemini-2.5-flash-lite',
    'flash': 'gemini-2.5-flash',
    'pro': 'gemini-2.5-pro',
}

# 内容风格定义
CONTENT_STYLES = {
    'life_vlog': {
        'name': '生活记录/日常分享',
        'description': '记录日常生活、心情、随想等内容',
        'keywords': ['日常', '生活', '分享', '心情', '记录', 'vlog', '随拍'],
    },
    'quote_wisdom': {
        'name': '纯文字/金句/人生道理',
        'description': '以文字为主，分享人生感悟、道理、名言警句',
        'keywords': ['道理', '感悟', '人生', '智慧', '语录', '名言', '警句', '文案'],
    },
    'news_info': {
        'name': '新闻资讯/知识科普',
        'description': '分享新闻事件、科普知识、行业动态',
        'keywords': ['新闻', '资讯', '科普', '知识', '热点', '动态', '报道'],
    },
    'fashion_look': {
        'name': '穿搭/美妆/颜值分享',
        'description': '服装搭配、美妆教程、颜值展示',
        'keywords': ['穿搭', '搭配', 'OOTD', '美妆', '妆容', '颜值', '造型'],
    },
    'food_review': {
        'name': '美食探店/食谱分享',
        'description': '餐厅探店、美食制作、食谱分享',
        'keywords': ['美食', '探店', '餐厅', '食谱', '做饭', '菜谱', '小吃'],
    },
    'travel_guide': {
        'name': '旅行攻略/景点推荐',
        'description': '旅行攻略、景点推荐、行程分享',
        'keywords': ['旅行', '攻略', '景点', '打卡', '游玩', '路线', '攻略'],
    },
    'tech_review': {
        'name': '数码测评/产品评测',
        'description': '数码产品测评、开箱、使用体验',
        'keywords': ['测评', '开箱', '数码', '产品', '体验', '评测', '设备'],
    },
    'study_notes': {
        'name': '学习笔记/干货教程',
        'description': '学习笔记、教程、干货分享',
        'keywords': ['笔记', '教程', '干货', '学习', '分享', '技巧', '方法'],
    },
    'fitness': {
        'name': '健身运动/减肥塑形',
        'description': '健身教程、运动打卡、减肥经验、身材管理',
        'keywords': ['健身', '运动', '减肥', '瘦身', '塑形', '瑜伽', '马甲线', '腹肌', '锻炼'],
    },
    'emotional': {
        'name': '情感关系/恋爱心理',
        'description': '恋爱感悟、情感分析、关系建议、心理成长',
        'keywords': ['恋爱', '情感', '分手', '表白', '心理', '关系', '单身', 'crush'],
    },
}

# ==================== 提示词模板 ====================

STYLE_PROMPTS = {
    'life_vlog': """你是一个专业的生活记录内容分析师。请详细分析这组生活记录类图文笔记，输出结构化的分析报告。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 生活记录/日常分享
- **核心主题**: [一句话概括这篇生活记录的主题]
- **记录场景**: [居家/外出/工作/学习/旅行/聚会/其他]
- **情绪基调**: [开心/温馨/平静/忧伤/兴奋/其他]

## 📖 内容概要（100-200字）
[用精炼的语言概括生活记录的核心内容和情境]

## 🎯 生活细节捕捉
### 场景描述
- **环境**: [记录的场所环境特点]
- **时间**: [大概的时间段，如早晨/午后/夜晚等]
- **氛围**: [整体氛围感受]

### 关键元素
[列举图文中的关键元素，如人物、物品、场景等]
- 元素1: [描述]
- 元素2: [描述]

## 💭 情感与共鸣
### 作者情绪
- **主要情绪**: [作者通过内容表达的主要情绪]
- **情绪表达方式**: [直接表达/含蓄流露/其他]

### 共鸣点分析
[内容可能引起读者共鸣的地方]
- **情感共鸣**: [什么样的情感共鸣]
- **场景共鸣**: [什么样的共同经历或场景]

## 📸 视觉风格分析
- **图片风格**: [自然抓拍/精心摆拍/自拍/他拍/静物特写]
- **色调氛围**: [温暖/冷淡/明亮/柔和/其他]
- **构图特点**: [构图方式的特点]
- **审美取向**: [作者的审美风格倾向]

## ✨ 灵感与启发
[从这篇生活记录中获得的启发或灵感]
- **生活方式启发**: [...]
- **审美启发**: [...]
- **情绪价值**: [给人什么感觉]

## 📝 作者画像推断
基于内容风格，推测作者的特点：
- **性格倾向**: [活泼开朗/内敛安静/幽默风趣/其他]
- **生活态度**: [积极乐观/随性自在/精致生活/其他]
- **内容特色**: [作者的生活记录有什么独特之处]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'quote_wisdom': """你是一个专业的金句和人生智慧内容分析师。请详细分析这组以文字为主的图文笔记，提取其中的人生智慧和表达技巧。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 纯文字/金句/人生道理
- **核心主题**: [一句话概括核心观点]
- **内容形式**: [单句金句/多条语录/段落论述/对话形式]
- **表达风格**: [直接说理/比喻修辞/故事引申/对比论证]

## 📖 内容概要（100-200字）
[概括文字内容的核心思想]

## 🎯 核心观点提取
### 主要论点
[提炼出文字的核心观点]
- **观点1**: [详细说明]
- **观点2**: [详细说明]
- **观点3**: [详细说明]

### 论证逻辑
[分析作者是如何展开论述的]
- **论证方式**: [讲道理/举例子/打比方/引用名言]
- **逻辑结构**: [如何层层递进]

## 💎 金句提取
### 原创金句
[提取文中精辟、有创意的句子]
1. "原句内容"
   - 解析: [为什么这句话有价值]

2. "原句内容"
   - 解析: [...]

### 引用/化用
[如果内容引用了名言、俗语等]
- **引用内容**: "..."
- **出处**: [如果能识别]
- **化用方式**: [如何化用或改编]

## 🎨 表达技巧分析
### 修辞手法
- **修辞1**: [比喻/排比/对比/设问等] - [举例说明]
- **修辞2**: [...] - [...]

### 语言特色
- **表达风格**: [简洁有力/温暖治愈/犀利直接/幽默风趣]
- **节奏感**: [长短句搭配、韵律特点]
- **关键词**: [反复出现或强调的关键词]

## 💡 使用建议
### 适用场景
[这些道理适合什么情况下使用]
- **应用场景1**: [说明]
- **应用场景2**: [说明]

### 注意事项
[使用时需要注意什么]
- **注意事项1**: [...]
- **注意事项2**: [...]

## 📝 文字风格画像
- **作者调性**: [理性思辨/情感抒发/鸡汤治愈/犀利吐槽]
- **表达特色**: [作者的文字有什么独特风格]
- **目标受众**: [内容面向什么样的读者]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'news_info': """你是一个专业的新闻资讯和知识科普内容分析师。请详细分析这组新闻资讯/科普知识类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 新闻资讯/知识科普
- **核心主题**: [一句话概括主题]
- **内容领域**: [科技/民生/娱乐/财经/国际/体育/其他]
- **时效性**: [热点新闻/行业动态/知识科普/其他]

## 📖 内容概要（100-200字）
[概括新闻/科普的核心内容]

## 🎯 关键信息提取
### 新闻要素（如适用）
- **事件时间**: [何时发生]
- **事件地点**: [何地发生]
- **涉及人物/机构**: [谁]
- **事件经过**: [发生了什么]
- **影响/意义**: [有什么影响]

### 知识要点（如适用）
[科普内容的核心知识点]
- **知识点1**: [详细说明]
- **知识点2**: [详细说明]
- **知识点3**: [详细说明]

## 📊 信息质量评估
### 事实核查
- **信息来源**: [如果能推测信息源]
- **事实核查**: [哪些信息可验证]
- **完整性**: [信息是否完整]

### 客观性
- **报道角度**: [客观中立/有明显倾向]
- **主观色彩**: [是否有明显的个人观点/情绪]
- **平衡性**: [是否有多方观点]

## 💡 知识价值
### 新颖性
- **信息新鲜度**: [★★★★★] - [信息有多新鲜]
- **内容稀缺性**: [★★★★★] - [是否难以获取]

### 实用性
- **知识价值**: [高/中/低] - [说明理由]
- **可操作性**: [高/中/低] - [能否转化为行动]

## 🔗 延伸了解
### 相关背景
[补充相关背景信息]
- **背景1**: [...]
- **背景2**: [...]

### 值得关注
[基于此内容，值得进一步了解的话题]
- **延伸话题1**: [说明]
- **延伸话题2**: [说明]

## 📝 内容风格分析
- **表达方式**: [专业严谨/通俗易懂/生动有趣/其他]
- **结构特点**: [内容如何组织]
- **受众定位**: [面向什么样的读者]

## ⚠️ 注意事项
[阅读时需要注意什么]
- **核实建议**: [哪些信息需要进一步核实]
- **理解提示**: [理解时需要注意的要点]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'fashion_look': """你是一个专业的穿搭美妆内容分析师。请详细分析这组穿搭/美妆类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 穿搭/美妆/颜值分享
- **主题**: [一句话概括穿搭/美妆主题]
- **风格类型**: [如：韩系/日系/欧美/复古/简约/甜酷等]
- **适用场景**: [日常通勤/约会/职场/运动/派对/其他]

## 📖 内容概要（100-200字）
[概括穿搭/美妆的核心内容和亮点]

## 👔 穿搭分析（如适用）
### 单品清单
[提取穿搭的单品信息]
- **上装**: [颜色/款式/材质/品牌]
- **下装**: [颜色/款式/材质/品牌]
- **外套**: [颜色/款式/材质/品牌]
- **鞋子**: [颜色/款式/材质/品牌]
- **配饰**: [包包/首饰/帽子等]

### 搭配技巧
[分析穿搭的技巧和思路]
- **色彩搭配**: [颜色如何组合]
- **层次搭配**: [如何进行层次叠穿]
- **比例把控**: [上下装比例、腰线位置等]
- **风格协调**: [如何营造整体风格]

## 💄 美妆分析（如适用）
### 妆容要点
- **底妆**: [粉底色号/妆感特点]
- **眼妆**: [眼影色调/眼线/睫毛特点]
- **唇妆**: [口红色号/质地]
- **特色**: [妆容的亮点]

### 护肤/发型（如提到）
- **发型**: [发型特点]
- **护肤**: [提到的护肤产品或心得]

## 🎨 视觉分析
### 图片风格
- **拍摄场景**: [室内/室外/特定场所]
- **拍摄角度**: [全身/半身/特写/对镜自拍等]
- **构图特点**: [构图方式]
- **光线运用**: [自然光/室内光/侧光等]

### 色彩分析
- **主色调**: [整体色彩倾向]
- **配色方案**: [如何进行颜色搭配]
- **视觉效果**: [色彩给人的感受]

## 💡 参考价值
### 适合人群
- **体型**: [适合什么体型]
- **肤色**: [适合什么肤色]
- **风格偏好**: [适合什么风格偏好]
- **年龄段**: [适合什么年龄段]

### 可操作性
- **模仿难度**: [高/中/低] - [说明]
- **单品获取**: [难/中/易] - [说明]
- **成本估算**: [高/中/低] - [说明]

## 📝 风格总结
- **整体风格定位**: [一句话总结风格]
- **穿搭/美妆理念**: [作者的风格理念]
- **特色标签**: [如#极简穿搭#韩系妆容#等]

## 🔗 相关推荐
[基于此风格，值得尝试的类似搭配]
- **推荐1**: [说明]
- **推荐2**: [说明]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'food_review': """你是一个专业的美食内容分析师。请详细分析这组美食类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 美食探店/食谱分享
- **主题**: [一句话概括美食主题]
- **美食类型**: [中餐/西餐/日料/韩料/东南亚菜/甜品/小吃/其他]
- **内容形式**: [探店测评/食谱教程/美食推荐]

## 📖 内容概要（100-200字）
[概括美食内容的核心信息]

## 🍽️ 探店分析（如适用）
### 店铺信息
- **店名**: [如果能识别]
- **位置**: [大概位置]
- **人均消费**: [如果能推测]
- **推荐指数**: [★★★★★]

### 菜品测评
[分析的菜品]
- **菜品1**: [名称 + 口感/味道 + 评价]
- **菜品2**: [名称 + 口感/味道 + 评价]
- **菜品3**: [名称 + 口感/味道 + 评价]

### 探店体验
- **环境氛围**: [环境描述]
- **服务体验**: [服务评价]
- **性价比**: [高/中/低]

## 👨‍🍳 食谱分析（如适用）
### 食材清单
- **主料**: [列举主要食材]
- **辅料**: [列举辅助食材]
- **调料**: [列举调料]

### 制作步骤
[提取制作要点]
- **步骤1**: [关键要点]
- **步骤2**: [关键要点]
- **步骤3**: [关键要点]

### 烹饪技巧
- **技巧1**: [说明]
- **技巧2**: [说明]

## 📸 视觉呈现
### 图片特点
- **拍摄风格**: [俯拍/平视/特写/对焦等]
- **构图特点**: [构图方式]
- **光线**: [自然光/室内光/补光]
- **色彩**: [色彩倾向，如暖色调食欲感等]

### 食物呈现
- **摆盘**: [摆盘特点]
- **分量**: [视觉分量感]
- **质感**: [食物质感的呈现]

## 💡 参考价值
### 实用信息
- **推荐理由**: [为什么值得推荐/不值得]
- **适合场景**: [约会/聚餐/一人食/其他]
- **注意事项**: [点餐/制作时的注意事项]

### 可操作性
- **探店**: [容易找到/需要预约/其他]
- **制作**: [难度高/中/低]

## 📝 美食风格
- **口味偏好**: [作者的口味倾向]
- **美食风格**: [精致/家常/创意/传统]
- **推荐指数**: [★★★★★]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'travel_guide': """你是一个专业的旅行内容分析师。请详细分析这组旅行攻略类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 旅行攻略/景点推荐
- **目的地**: [旅行目的地]
- **旅行类型**: [国内游/出境游/城市漫步/自然风光/人文历史]
- **内容形式**: [完整攻略/景点推荐/行程分享]

## 📖 内容概要（100-200字）
[概括旅行内容的核心信息]

## 🗺️ 目的地信息
### 基本信息
- **地点**: [具体地点]
- **最佳时间**: [什么时候去最好]
- **建议时长**: [建议玩几天]
- **预算估算**: [高/中/低]

### 交通信息
- **如何到达**: [交通方式]
- **当地交通**: [如何移动]

## 🎯 景点体验
### 推荐景点
[提到的景点或体验]
- **景点1**: [名称 + 特色 + 推荐理由]
- **景点2**: [名称 + 特色 + 推荐理由]
- **景点3**: [名称 + 特色 + 推荐理由]

### 行程建议
[推荐的行程安排]
- **Day1**: [主要安排]
- **Day2**: [主要安排]

## 📸 视觉分析
### 图片风格
- **拍摄风格**: [风景/人像/纪实/打卡]
- **构图特点**: [构图方式]
- **光线**: [拍摄时光线特点]
- **季节特征**: [图片反映的季节]

### 视觉吸引力
- **画面美感**: [★★★★★]
- **真实度**: [★★★★★] - [是否过度修图]
- **出片度**: [★★★★★] - [是否容易拍出好看照片]

## 💡 实用建议
### 旅行贴士
- **必备物品**: [列举]
- **注意事项**: [需要注意什么]
- **避坑指南**: [避免哪些坑]

### 住宿/美食
- **住宿建议**: [住宿区域推荐]
- **美食推荐**: [推荐美食]

## 📝 攻略质量
- **信息完整性**: [高/中/低]
- **实用价值**: [高/中/低]
- **原创性**: [高/中/低]

## 🔗 延伸推荐
- **相似目的地**: [推荐类似的地方]
- **最佳搭配**: [可以组合去的其他地方]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'tech_review': """你是一个专业的数码产品测评内容分析师。请详细分析这组数码测评类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 数码测评/产品评测
- **产品类型**: [手机/电脑/耳机/配件/智能家居/其他]
- **内容形式**: [开箱/使用体验/对比评测/购买建议]

## 📖 内容概要（100-200字）
[概括测评内容的核心信息]

## 📱 产品信息
### 基本信息
- **产品名称**: [产品名]
- **型号**: [具体型号]
- **价格**: [参考价格]
- **购买渠道**: [如果能识别]

### 产品特点
- **主要卖点**: [列举3-5个]
- **目标用户**: [适合什么人群]

## ⭐ 测评维度
### 外观设计
- **设计风格**: [简约/商务/时尚/其他]
- **做工质感**: [评价]
- **尺寸重量**: [描述]

### 功能性能
- **核心功能**: [主要功能表现]
- **性能表现**: [评价]
- **使用体验**: [实际使用感受]

### 续航/其他
- **续航能力**: [评价]
- **充电速度**: [评价]
- **特色功能**: [独特功能]

## 📊 优缺点分析
### 优点
- **优点1**: [说明]
- **优点2**: [说明]
- **优点3**: [说明]

### 缺点
- **缺点1**: [说明]
- **缺点2**: [说明]

### 踩坑点
[购买或使用时需要注意的问题]

## 💰 购买指导
### 推荐指数
- **综合评分**: [★★★★★]
- **推荐购买**: [是/否/视情况]

### 适合人群
- **推荐人群**: [列举适合的人群]
- **不推荐**: [不适合什么人]

### 购买建议
- **最佳购买时机**: [促销/日常]
- **版本选择**: [哪个版本最值得买]

## 📝 测评质量
- **专业性**: [高/中/低]
- **客观性**: [高/中/低]
- **实用性**: [高/中/低]

## 🔗 相关推荐
- **同类竞品**: [值得对比的其他产品]
- **相关配件**: [值得购买的配件]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'study_notes': """你是一个专业的学习干货内容分析师。请详细分析这组学习笔记/干货教程类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 学习笔记/干货教程
- **知识领域**: [学科分类/技能类型]
- **内容形式**: [笔记整理/教程分享/方法总结/技巧推荐]
- **难度级别**: [入门/进阶/高级]

## 📖 内容概要（100-200字）
[概括学习内容的要点]

## 📚 知识提取
### 核心知识点
[提取主要知识点]
- **知识点1**: [详细说明]
- **知识点2**: [详细说明]
- **知识点3**: [详细说明]

### 方法技巧
[提取的方法和技巧]
- **方法1**: [说明 + 使用场景]
- **方法2**: [说明 + 使用场景]

### 重点难点
- **重点**: [需要重点掌握的内容]
- **难点**: [容易理解困难的地方]
- **易错点**: [容易犯错的地方]

## 🎓 学习价值
### 实用性
- **知识价值**: [高/中/低] - [说明理由]
- **可操作性**: [高/中/低] - [说明]

### 适用人群
- **目标受众**: [适合什么人学习]
- **前置要求**: [需要什么基础]
- **应用场景**: [在什么场景下使用]

## 📝 内容质量分析
### 结构性
- **逻辑清晰**: [是/否] - [评价]
- **层次分明**: [是/否] - [评价]
- **完整性**: [信息是否完整]

### 表达方式
- **呈现形式**: [文字/图示/表格/流程图]
- **讲解风格**: [简洁/详细/生动/枯燥]
- **易懂程度**: [高/中/低]

## 💡 学习建议
### 学习路径
[如何学习这些内容]
- **Step1**: [第一阶段]
- **Step2**: [第二阶段]
- **Step3**: [第三阶段]

### 配套资源
[是否提到配套资源]
- **推荐工具**: [相关的工具或软件]
- **延伸阅读**: [值得深入了解的资料]

## 🎯 使用指南
### 立即可用
[学完可以立即应用的点]
- **应用1**: [说明]
- **应用2**: [说明]

### 长期价值
[内容的长期价值]
- **知识体系**: [在知识体系中的位置]
- **可复用性**: [高/中/低]

## 🔗 延伸学习
- **进阶方向**: [可以深入学习的方向]
- **相关主题**: [相关的学习主题]
- **推荐资源**: [值得关注的资源]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'fitness': """你是一个专业的健身运动内容分析师。请详细分析这组健身运动/减肥塑形类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 健身运动/减肥塑形
- **训练类型**: [力量训练/有氧运动/瑜伽普拉提/HIIT/综合训练]
- **难度级别**: [入门/进阶/高级]
- **目标导向**: [增肌/减脂/塑形/健康/其他]

## 📖 内容概要（100-200字）
[概括健身内容的核心信息]

## 🏋️ 训练分析
### 动作分解
[提取主要训练动作]
- **动作1**: [名称 + 目标肌群 + 要点]
- **动作2**: [名称 + 目标肌群 + 要点]
- **动作3**: [名称 + 目标肌群 + 要点]

### 训练计划
[训练安排]
- **训练频率**: [每周几次]
- **组数次数**: [具体安排]
- **休息时间**: [组间休息]

### 强度评估
- **运动强度**: [低/中/高] - [说明]
- **训练量**: [适中/过大/不足]
- **科学性**: [★★★★★] - [训练是否科学合理]

## 🥗 饮食减脂
### 饮食建议
- **饮食原则**: [主要的饮食建议]
- **禁忌食物**: [需要避免的食物]
- **推荐食物**: [推荐的食物类型]

### 减脂/增肌方法
- **热量控制**: [是否有热量建议]
- **营养搭配**: [碳水/蛋白质/脂肪比例]
- **补充剂**: [是否提到补剂]

## 💪 效果参考
### 预期效果
- **效果描述**: [预期达到的效果]
- **时间周期**: [需要多长时间]
- **个体差异**: [效果因人而异的因素]

### 适合人群
- **性别**: [男/女/皆可]
- **年龄段**: [适合什么年龄段]
- **健身基础**: [新手/有基础/高级]
- **身体条件**: [特殊注意事项]

## ⚠️ 安全提醒
### 注意事项
- **安全要点**: [训练时需要注意什么]
- **常见错误**: [容易做错的地方]
- **禁忌人群**: [不适合哪些人]

## 💡 可操作性
- **难度**: [★★★★★] - [执行难度]
- **所需设备**: [需要哪些器械]
- **场地要求**: [健身房/居家均可]
- **时间成本**: [每次训练时长]

## 🔗 延伸学习
- **进阶训练**: [可以进一步学习的方向]
- **相关知识**: [值得了解的健身知识]
- **推荐资源**: [值得关注的账号或视频]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'emotional': """你是一个专业的情感关系内容分析师。请详细分析这组情感关系/恋爱心理类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 情感关系/恋爱心理
- **核心主题**: [一句话概括主题]
- **情感基调**: [温暖/治愈/扎心/理性/感性]
- **内容形式**: [观点分享/故事叙述/问答形式]

## 📖 内容概要（100-200字）
[概括情感内容的核心信息]

## 🎯 观点分析
### 核心观点
[提取主要情感观点]
- **观点1**: [详细说明]
- **观点2**: [详细说明]
- **观点3**: [详细说明]

### 情感分析
- **情感类型**: [恋爱/友情/亲情/自我成长]
- **情感状态**: [单恋/热恋/分手/暧昧/其他]
- **情感层次**: [表面的/深层的]

### 心理机制
[分析背后的心理机制]
- **心理需求**: [表达什么样的心理需求]
- **行为模式**: [情感中的行为模式分析]
- **认知偏差**: [是否存在认知偏差]

## 💭 情感价值
### 共鸣点
[内容可能引起共鸣的地方]
- **情感共鸣**: [什么样的情感共鸣]
- **普适性**: [★★★★★] - [适用范围多广]
- **情感支持**: [给人什么安慰或力量]

### 情绪价值
- **情绪类型**: [治愈/激励/反思/释放]
- **情绪强度**: [强烈/温和/其他]

## 💡 行动建议
### 可操作建议
[提供的具体建议]
- **建议1**: [说明 + 如何执行]
- **建议2**: [说明 + 如何执行]

### 沟通技巧
[如果是关系类内容]
- **沟通方式**: [建议的沟通方式]
- **表达技巧**: [如何表达情感]
- **边界设定**: [如何设定关系边界]

### 自我提升
[关于个人成长的建议]
- **心态调整**: [如何调整心态]
- **自我认知**: [如何认识自己]
- **成长方向**: [个人成长的建议]

## ⚠️ 注意事项
### 局限性
- **适用范围**: [这些建议的适用边界]
- **特殊情况**: [什么情况下不适用]

### 风险提醒
- **潜在风险**: [盲目跟从可能的风险]
- **理性判断**: [需要理性思考的点]

## 📝 作者风格
- **表达风格**: [温柔治愈/犀利直接/理性分析/感性抒发]
- **可信度**: [高/中/低] - [理由]
- **内容特色**: [作者的情感内容有什么独特之处]

## 🔗 延伸思考
[基于情感内容，值得深入思考的方向]
- **自我探索**: [值得思考的自我问题]
- **关系思考**: [关于关系的深度思考]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'general': """你是一个专业的小红书图文笔记分析师。请详细分析这组图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **笔记类型**: [根据内容判断类型]
- **核心主题**: [一句话概括]
- **内容风格**: [描述内容风格]

## 📖 内容概要（150-250字）
[结合图片和文字，用精炼的语言概括笔记核心内容]

## 🎯 核心信息提取
### 主要内容
[列举主要内容要点]
- 要点1: [详细说明]
- 要点2: [详细说明]
- 要点3: [详细说明]

### 关键细节
[值得关注的关键信息]

## 📸 视觉分析
### 图片特点
- **图片数量**: [图片数量]张
- **图片风格**: [描述图片风格]
- **视觉效果**: [整体视觉效果]

### 内容呈现
- **图文配合**: [图文如何配合]
- **排版特点**: [排版特点]

## 💡 亮点与价值
### 内容亮点
[这篇笔记的亮点]
- 亮点1: [...]
- 亮点2: [...]

### 价值评估
- **实用性**: [高/中/低] - [说明]
- **新颖性**: [高/中/低] - [说明]
- **可操作性**: [高/中/低] - [说明]

## 📝 作者风格分析
- **表达方式**: [描述表达方式]
- **内容倾向**: [描述内容倾向]
- **特色标签**: [相关标签]

## ⚠️ 注意事项
[需要留意的点]

## 🔗 相关延伸
[值得了解的相关内容]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。

## 💭 情感与共鸣
### 作者情绪
- **主要情绪**: [作者通过内容表达的主要情绪]
- **情绪表达方式**: [直接表达/含蓄流露/其他]

### 共鸣点分析
[内容可能引起读者共鸣的地方]
- **情感共鸣**: [什么样的情感共鸣]
- **场景共鸣**: [什么样的共同经历或场景]

## 📸 视觉风格分析
- **图片风格**: [自然抓拍/精心摆拍/自拍/他拍/静物特写]
- **色调氛围**: [温暖/冷淡/明亮/柔和/其他]
- **构图特点**: [构图方式的特点]
- **审美取向**: [作者的审美风格倾向]

## ✨ 灵感与启发
[从这篇生活记录中获得的启发或灵感]
- **生活方式启发**: [...]
- **审美启发**: [...]
- **情绪价值**: [给人什么感觉]

## 📝 作者画像推断
基于内容风格，推测作者的特点：
- **性格倾向**: [活泼开朗/内敛安静/幽默风趣/其他]
- **生活态度**: [积极乐观/随性自在/精致生活/其他]
- **内容特色**: [作者的生活记录有什么独特之处]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'quote_wisdom': """你是一个专业的金句和人生智慧内容分析师。请详细分析这组以文字为主的图文笔记，提取其中的人生智慧和表达技巧。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 纯文字/金句/人生道理
- **核心主题**: [一句话概括核心观点]
- **内容形式**: [单句金句/多条语录/段落论述/对话形式]
- **表达风格**: [直接说理/比喻修辞/故事引申/对比论证]

## 📖 内容概要（100-200字）
[概括文字内容的核心思想]

## 🎯 核心观点提取
### 主要论点
[提炼出文字的核心观点]
- **观点1**: [详细说明]
- **观点2**: [详细说明]
- **观点3**: [详细说明]

### 论证逻辑
[分析作者是如何展开论述的]
- **论证方式**: [讲道理/举例子/打比方/引用名言]
- **逻辑结构**: [如何层层递进]

## 💎 金句提取
### 原创金句
[提取文中精辟、有创意的句子]
1. "原句内容"
   - 解析: [为什么这句话有价值]

2. "原句内容"
   - 解析: [...]

### 引用/化用
[如果内容引用了名言、俗语等]
- **引用内容**: "..."
- **出处**: [如果能识别]
- **化用方式**: [如何化用或改编]

## 🎨 表达技巧分析
### 修辞手法
- **修辞1**: [比喻/排比/对比/设问等] - [举例说明]
- **修辞2**: [...] - [...]

### 语言特色
- **表达风格**: [简洁有力/温暖治愈/犀利直接/幽默风趣]
- **节奏感**: [长短句搭配、韵律特点]
- **关键词**: [反复出现或强调的关键词]

## 🧠 认知价值分析
### 智慧类型
- **智慧类型**: [人生哲理/处世智慧/情感认知/成长思维/其他]
- **新颖性**: [★★★★★] - [观点是否新颖独特]
- **普适性**: [★★★★★] - [适用范围多广]

### 启发性
[这些观点给人什么启发]
- **认知启发**: [对认识世界的启发]
- **行动启发**: [对实践行动的启发]
- **情感启发**: [对情感态度的启发]

## 📝 文字风格画像
- **作者调性**: [理性思辨/情感抒发/鸡汤治愈/犀利吐槽]
- **表达特色**: [作者的文字有什么独特风格]
- **目标受众**: [内容面向什么样的读者]

## ⚠️ 批判性思考
### 内容评估
- **观点可靠性**: [高/中/低] - [理由]
- **逻辑严密性**: [高/中/低] - [理由]
- **潜在问题**: [是否有逻辑漏洞、观点偏颇等]

### 使用建议
- **适用场景**: [这些道理适合什么情况下引用]
- **注意事项**: [使用时需要注意什么]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'news_info': """你是一个专业的新闻资讯和知识科普内容分析师。请详细分析这组新闻资讯/科普知识类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 新闻资讯/知识科普
- **核心主题**: [一句话概括主题]
- **内容领域**: [科技/民生/娱乐/财经/国际/体育/其他]
- **时效性**: [热点新闻/行业动态/知识科普/其他]

## 📖 内容概要（100-200字）
[概括新闻/科普的核心内容]

## 🎯 关键信息提取
### 新闻要素（如适用）
- **事件时间**: [何时发生]
- **事件地点**: [何地发生]
- **涉及人物/机构**: [谁]
- **事件经过**: [发生了什么]
- **影响/意义**: [有什么影响]

### 知识要点（如适用）
[科普内容的核心知识点]
- **知识点1**: [详细说明]
- **知识点2**: [详细说明]
- **知识点3**: [详细说明]

## 📊 信息质量评估
### 可靠性分析
- **信息来源**: [如果能推测信息源]
- **事实核查**: [哪些信息可验证]
- **完整性**: [信息是否完整/有无遗漏]

### 客观性
- **报道角度**: [客观中立/有明显倾向]
- **主观色彩**: [是否有明显的个人观点/情绪]
- **平衡性**: [是否有多方观点]

## 💡 知识价值
### 新颖性
- **信息新鲜度**: [★★★★★] - [信息有多新鲜]
- **内容稀缺性**: [★★★★★] - [是否难以获取]

### 实用性
- **知识价值**: [高/中/低] - [说明理由]
- **可操作性**: [高/中/低] - [能否转化为行动]

## 🔗 延伸了解
### 相关背景
[补充相关背景信息]
- **背景1**: [...]
- **背景2**: [...]

### 值得关注
[基于此内容，值得进一步了解的话题]
- **延伸话题1**: [说明]
- **延伸话题2**: [说明]

## 📝 内容风格分析
- **表达方式**: [专业严谨/通俗易懂/生动有趣/其他]
- **结构特点**: [内容如何组织]
- **受众定位**: [面向什么样的读者]

## ⚠️ 注意事项
[阅读时需要注意什么]
- **核实建议**: [哪些信息需要进一步核实]
- **理解提示**: [理解时需要注意的要点]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'fashion_look': """你是一个专业的穿搭美妆内容分析师。请详细分析这组穿搭/美妆类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 穿搭/美妆/颜值分享
- **主题**: [一句话概括穿搭/美妆主题]
- **风格类型**: [如：韩系/日系/欧美/复古/简约/甜酷等]
- **适用场景**: [日常通勤/约会/职场/运动/派对/其他]

## 📖 内容概要（100-200字）
[概括穿搭/美妆的核心内容和亮点]

## 👔 穿搭分析（如适用）
### 单品清单
[提取穿搭的单品信息]
- **上装**: [颜色/款式/材质/品牌]
- **下装**: [颜色/款式/材质/品牌]
- **外套**: [颜色/款式/材质/品牌]
- **鞋子**: [颜色/款式/材质/品牌]
- **配饰**: [包包/首饰/帽子等]

### 穿搭技巧
[分析穿搭的技巧和思路]
- **色彩搭配**: [颜色如何组合]
- **层次搭配**: [如何进行层次叠穿]
- **比例把控**: [上下装比例、腰线位置等]
- **风格协调**: [如何营造整体风格]

## 💄 美妆分析（如适用）
### 妆容要点
- **底妆**: [粉底色号/妆感特点]
- **眼妆**: [眼影色调/眼线/睫毛特点]
- **唇妆**: [口红色号/质地]
- **特色**: [妆容的亮点]

### 护肤/发型（如提到）
- **发型**: [发型特点]
- **护肤**: [提到的护肤产品或心得]

## 🎨 视觉分析
### 图片风格
- **拍摄场景**: [室内/室外/特定场所]
- **拍摄角度**: [全身/半身/特写/对镜自拍等]
- **构图特点**: [构图方式]
- **光线运用**: [自然光/室内光/侧光等]

### 色彩分析
- **主色调**: [整体色彩倾向]
- **配色方案**: [如何进行颜色搭配]
- **视觉效果**: [色彩给人的感受]

## 💡 参考价值
### 适合人群
- **体型**: [适合什么体型]
- **肤色**: [适合什么肤色]
- **风格偏好**: [适合什么风格偏好]
- **年龄段**: [适合什么年龄段]

### 可操作性
- **模仿难度**: [高/中/低] - [说明]
- **单品获取**: [难/中/易] - [说明]
- **成本估算**: [高/中/低] - [说明]

## 📝 风格总结
- **整体风格定位**: [一句话总结风格]
- **穿搭/美妆理念**: [作者的风格理念]
- **特色标签**: [如#极简穿搭#韩系妆容#等]

## 🔗 相关推荐
[基于此风格，值得尝试的类似搭配]
- **推荐1**: [说明]
- **推荐2**: [说明]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'food_review': """你是一个专业的美食内容分析师。请详细分析这组美食类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 美食探店/食谱分享
- **主题**: [一句话概括美食主题]
- **美食类型**: [中餐/西餐/日料/韩料/东南亚菜/甜品/小吃/其他]
- **内容形式**: [探店测评/食谱教程/美食推荐]

## 📖 内容概要（100-200字）
[概括美食内容的核心信息]

## 🍽️ 探店分析（如适用）
### 店铺信息
- **店名**: [如果能识别]
- **位置**: [大概位置]
- **人均消费**: [如果能推测]
- **推荐指数**: [★★★★★]

### 菜品测评
[分析的菜品]
- **菜品1**: [名称 + 口感/味道 + 评价]
- **菜品2**: [名称 + 口感/味道 + 评价]
- **菜品3**: [名称 + 口感/味道 + 评价]

### 探店体验
- **环境氛围**: [环境描述]
- **服务体验**: [服务评价]
- **性价比**: [高/中/低]

## 👨‍🍳 食谱分析（如适用）
### 食材清单
- **主料**: [列举主要食材]
- **辅料**: [列举辅助食材]
- **调料**: [列举调料]

### 制作步骤
[提取制作要点]
- **步骤1**: [关键要点]
- **步骤2**: [关键要点]
- **步骤3**: [关键要点]

### 烹饪技巧
- **技巧1**: [说明]
- **技巧2**: [说明]

## 📸 视觉呈现
### 图片特点
- **拍摄风格**: [俯拍/平视/特写/对焦等]
- **构图特点**: [构图方式]
- **光线**: [自然光/室内光/补光]
- **色彩**: [色彩倾向，如暖色调食欲感等]

### 食物呈现
- **摆盘**: [摆盘特点]
- **分量**: [视觉分量感]
- **质感**: [食物质感的呈现]

## 💡 参考价值
### 实用信息
- **推荐理由**: [为什么值得推荐/不值得]
- **适合场景**: [约会/聚餐/一人食/其他]
- **注意事项**: [点餐/制作时的注意事项]

### 可操作性
- **探店**: [容易找到/需要预约/其他]
- **制作**: [难度高/中/低]

## 📝 美食风格
- **口味偏好**: [作者的口味倾向]
- **美食风格**: [精致/家常/创意/传统]
- **推荐指数**: [★★★★★]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'travel_guide': """你是一个专业的旅行内容分析师。请详细分析这组旅行攻略类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 旅行攻略/景点推荐
- **目的地**: [旅行目的地]
- **旅行类型**: [国内游/出境游/城市漫步/自然风光/人文历史]
- **内容形式**: [完整攻略/景点推荐/行程分享]

## 📖 内容概要（100-200字）
[概括旅行内容的核心信息]

## 🗺️ 目的地信息
### 基本信息
- **地点**: [具体地点]
- **最佳时间**: [什么时候去最好]
- **建议时长**: [建议玩几天]
- **预算估算**: [高/中/低]

### 交通信息
- **如何到达**: [交通方式]
- **当地交通**: [如何移动]

## 🎯 景点/体验分析
### 推荐景点
[提到的景点或体验]
- **景点1**: [名称 + 特色 + 推荐理由]
- **景点2**: [名称 + 特色 + 推荐理由]
- **景点3**: [名称 + 特色 + 推荐理由]

### 行程建议
[推荐的行程安排]
- **Day1**: [主要安排]
- **Day2**: [主要安排]

## 📸 视觉分析
### 图片风格
- **拍摄风格**: [风景/人像/纪实/打卡]
- **构图特点**: [构图方式]
- **光线**: [拍摄时光线特点]
- **季节特征**: [图片反映的季节]

### 视觉吸引力
- **画面美感**: [★★★★★]
- **真实度**: [★★★★★] - [是否过度修图]
- **出片度**: [★★★★★] - [是否容易拍出好看照片]

## 💡 实用建议
### 旅行贴士
- **必备物品**: [列举]
- **注意事项**: [需要注意什么]
- **避坑指南**: [避免哪些坑]

### 住宿/美食
- **住宿建议**: [住宿区域推荐]
- **美食推荐**: [推荐美食]

## 📝 攻略质量
- **信息完整性**: [高/中/低]
- **实用价值**: [高/中/低]
- **原创性**: [高/中/低]

## 🔗 延伸推荐
- **相似目的地**: [推荐类似的地方]
- **最佳搭配**: [可以组合去的其他地方]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'tech_review': """你是一个专业的数码产品测评内容分析师。请详细分析这组数码测评类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 数码测评/产品评测
- **产品类型**: [手机/电脑/耳机/配件/智能家居/其他]
- **内容形式**: [开箱/使用体验/对比评测/购买建议]

## 📖 内容概要（100-200字）
[概括测评内容的核心信息]

## 📱 产品信息
### 基本信息
- **产品名称**: [产品名]
- **型号**: [具体型号]
- **价格**: [参考价格]
- **购买渠道**: [如果能识别]

### 产品特点
- **主要卖点**: [列举3-5个]
- **目标用户**: [适合什么人群]

## ⭐ 测评维度
### 外观设计
- **设计风格**: [简约/商务/时尚/其他]
- **做工质感**: [评价]
- **尺寸重量**: [描述]

### 功能性能
- **核心功能**: [主要功能表现]
- **性能表现**: [评价]
- **使用体验**: [实际使用感受]

### 续航/其他
- **续航能力**: [评价]
- **充电速度**: [评价]
- **特色功能**: [独特功能]

## 📊 优缺点分析
### 优点
- **优点1**: [说明]
- **优点2**: [说明]
- **优点3**: [说明]

### 缺点
- **缺点1**: [说明]
- **缺点2**: [说明]

### 踩坑点
[购买或使用时需要注意的问题]

## 💰 购买建议
### 推荐指数
- **综合评分**: [★★★★★]
- **推荐购买**: [是/否/视情况]

### 适合人群
- **推荐人群**: [列举适合的人群]
- **不推荐**: [不适合什么人]

### 购买建议
- **最佳购买时机**: [促销/日常]
- **版本选择**: [哪个版本最值得买]

## 📝 测评质量
- **专业性**: [高/中/低]
- **客观性**: [高/中/低]
- **实用性**: [高/中/低]

## 🔗 相关推荐
- **同类竞品**: [值得对比的其他产品]
- **相关配件**: [值得购买的配件]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'study_notes': """你是一个专业的学习干货内容分析师。请详细分析这组学习笔记/干货教程类图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **内容类型**: 学习笔记/干货教程
- **知识领域**: [学科分类/技能类型]
- **内容形式**: [笔记整理/教程分享/方法总结/技巧推荐]
- **难度级别**: [入门/进阶/高级]

## 📖 内容概要（100-200字）
[概括学习内容的要点]

## 📚 知识提取
### 核心知识点
[提取主要知识点]
- **知识点1**: [详细说明]
- **知识点2**: [详细说明]
- **知识点3**: [详细说明]

### 方法技巧
[提取的方法和技巧]
- **方法1**: [说明 + 使用场景]
- **方法2**: [说明 + 使用场景]

### 重点难点
- **重点**: [需要重点掌握的内容]
- **难点**: [容易理解困难的地方]
- **易错点**: [容易犯错的地方]

## 🎓 学习价值
### 实用性
- **知识价值**: [高/中/低] - [说明]
- **可操作性**: [高/中/低] - [说明]
- **新颖性**: [★★★★★]

### 适用人群
- **目标受众**: [适合什么人学习]
- **前置要求**: [需要什么基础]
- **应用场景**: [在什么场景下使用]

## 📝 内容质量分析
### 结构性
- **逻辑清晰**: [是/否] - [评价]
- **层次分明**: [是/否] - [评价]
- **完整性**: [信息是否完整]

### 表达方式
- **呈现形式**: [文字/图示/表格/流程图]
- **讲解风格**: [简洁/详细/生动/枯燥]
- **易懂程度**: [高/中/低]

## 💡 学习建议
### 学习路径
[如何学习这些内容]
- **Step1**: [第一阶段]
- **Step2**: [第二阶段]
- **Step3**: [第三阶段]

### 配套资源
[是否提到配套资源]
- **推荐工具**: [相关的工具或软件]
- **延伸阅读**: [值得深入了解的资料]

## 🎯 行动指南
### 立即可用
[学完可以立即应用的点]
- **应用1**: [说明]
- **应用2**: [说明]

### 长期价值
[内容的长期价值]
- **知识体系**: [在知识体系中的位置]
- **可复用性**: [高/中/低]

## 🔗 延伸学习
- **进阶方向**: [可以深入学习的方向]
- **相关主题**: [相关的学习主题]
- **推荐资源**: [值得关注的资源]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",

    'general': """你是一个专业的小红书图文笔记分析师。请详细分析这组图文笔记。

请严格按照以下格式输出：

## 📋 笔记基本信息
- **笔记类型**: [根据内容判断类型]
- **核心主题**: [一句话概括]
- **内容风格**: [描述内容风格]

## 📖 内容概要（150-250字）
[结合图片和文字，用精炼的语言概括笔记核心内容]

## 🎯 核心信息提取
### 主要内容
[列举主要内容要点]
- 要点1: [详细说明]
- 要点2: [详细说明]
- 要点3: [详细说明]

### 关键细节
[值得关注的关键信息]

## 📸 视觉分析
### 图片特点
- **图片数量**: [图片数量]张
- **图片风格**: [描述图片风格]
- **视觉效果**: [整体视觉效果]

### 内容呈现
- **图文配合**: [图文如何配合]
- **排版特点**: [排版特点]

## 💡 亮点与价值
### 内容亮点
[这篇笔记的亮点]
- 亮点1: [...]
- 亮点2: [...]

### 价值评估
- **实用性**: [高/中/低] - [说明]
- **新颖性**: [高/中/低] - [说明]
- **可操作性**: [高/中/低] - [说明]

## 📝 作者风格分析
- **表达方式**: [描述表达方式]
- **内容倾向**: [描述内容倾向]
- **特色标签**: [相关标签]

## ⚠️ 注意事项
[需要留意的点]

## 🔗 相关延伸
[值得了解的相关内容]

---

## 原始文案内容:

{text}

---

请确保输出结构完整，每个部分都要有实质内容。""",
}

# 风格自动识别提示词
STYLE_DETECTION_PROMPT = """请分析以下图文笔记的内容，判断它属于哪种内容风格类型。

可选的风格类型：
1. **life_vlog** - 生活记录/日常分享：记录日常生活、心情、随想
2. **quote_wisdom** - 纯文字/金句/人生道理：以文字为主，分享人生感悟、道理
3. **news_info** - 新闻资讯/知识科普：分享新闻事件、科普知识、行业动态
4. **fashion_look** - 穿搭/美妆/颜值分享：服装搭配、美妆教程
5. **food_review** - 美食探店/食谱分享：餐厅探店、美食制作
6. **travel_guide** - 旅行攻略/景点推荐：旅行攻略、景点推荐
7. **tech_review** - 数码测评/产品评测：数码产品测评、开箱
8. **study_notes** - 学习笔记/干货教程：学习笔记、教程、干货分享
9. **fitness** - 健身运动/减肥塑形：健身教程、运动打卡、减肥经验
10. **emotional** - 情感关系/恋爱心理：恋爱感悟、情感分析、关系建议

请仔细分析图片内容和文字描述，选择最匹配的一个风格类型。

## 文字内容:
{text}

## 图片描述:
[请观察图片内容，描述图片展示的是什么类型的内容]

请直接输出风格类型的英文名称（如 life_vlog、quote_wisdom 等），不要输出其他内容。
只输出一个最匹配的风格类型。"""


# ==================== API 配置 ====================

def get_api_key() -> str:
    """获取 Gemini API Key"""
    api_key = os.environ.get('GEMINI_API_KEY')
    if api_key:
        return api_key

    try:
        sys.path.insert(0, str(Path(__file__).parent.parent))
        from config_api import API_CONFIG
        api_key = API_CONFIG.get('gemini', {}).get('api_key')
        if api_key:
            return api_key
    except ImportError:
        pass

    return None


def configure_gemini(api_key: str = None) -> bool:
    """配置 Gemini API"""
    if not api_key:
        api_key = get_api_key()

    if not api_key:
        print("❌ 未找到 Gemini API Key")
        print("\n请通过以下方式之一配置 API Key:")
        print("1. 设置环境变量: export GEMINI_API_KEY='your-key'")
        print("2. 在 config_api.py 中添加:")
        print('   API_CONFIG = {"gemini": {"api_key": "your-key"}}')
        return False

    try:
        genai.configure(api_key=api_key)
        return True
    except Exception as e:
        print(f"❌ Gemini API 配置失败: {e}")
        return False


# ==================== 分析器 ====================

class XHSImageAnalyzer:
    """小红书图文分析器"""

    def __init__(self, model: str = 'flash-lite', api_key: str = None):
        self.api_key = api_key or get_api_key()
        self.model_name = GEMINI_MODELS.get(model, GEMINI_MODELS['flash'])
        self.model = model

        if not configure_gemini(self.api_key):
            raise ValueError("无法配置 Gemini API")

    def detect_style(self, text: str, image_files: List = None) -> str:
        """
        自动检测内容风格类型

        Args:
            text: 文字内容
            image_files: 已上传的图片文件对象（可选）

        Returns:
            检测到的风格类型
        """
        print(f"🔍 自动检测内容风格...")

        # 先用关键词快速检测
        text_lower = text.lower()
        for style_key, style_info in CONTENT_STYLES.items():
            for keyword in style_info['keywords']:
                if keyword in text:
                    print(f"   └─ 检测到关键词 '{keyword}' -> {style_info['name']}")
                    return style_key

        # 如果关键词没检测到，用 AI 分析
        if image_files:
            try:
                model = genai.GenerativeModel(self.model_name)
                contents = image_files + [STYLE_DETECTION_PROMPT.format(text=text)]

                response = model.generate_content(contents)
                detected_style = response.text.strip().lower()

                # 验证返回的风格是否有效
                if detected_style in CONTENT_STYLES:
                    print(f"   └─ AI 检测 -> {CONTENT_STYLES[detected_style]['name']}")
                    return detected_style
            except Exception as e:
                print(f"   └─ ⚠️ AI 检测失败: {e}")

        # 默认返回通用类型
        print(f"   └─ 使用默认风格 -> 通用分析")
        return 'general'

    def upload_images(self, image_paths: List[Path]) -> List:
        """上传图片到 Gemini Files API"""
        uploaded_files = []

        print(f"\n📤 上传图片到 Gemini...")
        print(f"{'='*60}")

        for i, img_path in enumerate(image_paths, 1):
            print(f"[{i}/{len(image_paths)}] {img_path.name}... ", end='', flush=True)

            try:
                img_file = genai.upload_file(
                    path=str(img_path),
                    display_name=img_path.name
                )

                # 等待处理完成
                while img_file.state.name == "PROCESSING":
                    time.sleep(1)
                    img_file = genai.get_file(img_file.name)

                if img_file.state.name == "ACTIVE":
                    size_mb = img_path.stat().st_size / (1024 * 1024)
                    print(f"✅ ({size_mb:.2f}MB)")
                    uploaded_files.append(img_file)
                else:
                    print(f"❌ 状态: {img_file.state.name}")

            except Exception as e:
                print(f"❌ {e}")

        print(f"{'='*60}")
        print(f"✅ 成功上传 {len(uploaded_files)}/{len(image_paths)} 张图片\n")

        return uploaded_files

    def analyze_note(self, text: str, image_files: List,
                     style: str = 'general') -> Tuple[str, dict]:
        """
        图文混合分析

        Args:
            text: 笔记文字内容
            image_files: 上传的图片文件对象列表
            style: 内容风格类型

        Returns:
            (分析结果, token信息)
        """
        prompt = STYLE_PROMPTS.get(style, STYLE_PROMPTS['general']).format(text=text)

        print(f"🤖 使用模型: {self.model_name}")
        print(f"📝 分析风格: {CONTENT_STYLES.get(style, {}).get('name', style)}")
        print(f"{'='*60}")

        try:
            model = genai.GenerativeModel(self.model_name)
            contents = image_files + [prompt]

            print(f"🔄 正在分析...")
            start_time = time.time()

            response = model.generate_content(contents)

            elapsed = time.time() - start_time
            print(f"✅ 分析完成! ({elapsed:.1f}秒)\n")

            # 提取 token 使用信息
            token_info = {
                'prompt_tokens': 0,
                'candidates_tokens': 0,
                'total_tokens': 0
            }

            if hasattr(response, 'usage_metadata') and response.usage_metadata:
                token_info['prompt_tokens'] = response.usage_metadata.prompt_token_count or 0
                token_info['candidates_tokens'] = response.usage_metadata.candidates_token_count or 0
                token_info['total_tokens'] = response.usage_metadata.total_token_count or 0

            return response.text, token_info

        except Exception as e:
            error_msg = f"❌ 分析失败: {e}"
            print(error_msg)
            return error_msg, {}

    def delete_files(self, files: List):
        """删除已上传的文件"""
        for f in files:
            try:
                genai.delete_file(f.name)
            except:
                pass

    def analyze_single_image(self, image_file) -> str:
        """
        分析单张图片，生成场景描述

        Args:
            image_file: 上传的图片文件对象

        Returns:
            图片描述文本
        """
        prompt = """请详细描述这张图片的内容，包括：

1. **场景环境**: 图片拍摄的地点（室内/室外、具体场所）
2. **主要元素**: 图片中的主要人物、物品或建筑
3. **色彩与光线**: 图片的色彩风格和光线特点
4. **氛围感受**: 图片传达的整体氛围或情感

请用简洁清晰的语言描述，2-3句话即可。"""

        try:
            model = genai.GenerativeModel(self.model_name)
            response = model.generate_content([image_file, prompt])
            return response.text.strip()
        except Exception as e:
            return f"图片描述生成失败: {e}"


# ==================== GitHub 图片上传 ====================

def get_github_config() -> tuple:
    """
    从环境变量或配置文件获取 GitHub 配置

    Returns:
        (token, repo) 或 (None, None)
    """
    import os

    # 从环境变量读取
    token = os.getenv('GITHUB_TOKEN')
    repo = os.getenv('GITHUB_REPO')

    if token and repo:
        return token, repo

    # 尝试从 config_api.py 读取
    try:
        sys.path.insert(0, str(Path(__file__).parent.parent))
        from config_api import API_CONFIG
        github_config = API_CONFIG.get('github', {})
        token = github_config.get('token')
        repo = github_config.get('repo')
        if token and repo:
            return token, repo
    except ImportError:
        pass

    # 尝试从用户主目录的配置文件读取
    config_file = Path.home() / '.github_upload_config'
    if config_file.exists():
        import json
        try:
            with open(config_file, 'r') as f:
                config = json.load(f)
                return config.get('token'), config.get('repo')
        except:
            pass

    return None, None


def upload_to_github(image_path: Path, token: str, repo: str, filename: str = None) -> Optional[str]:
    """
    上传图片到 GitHub 并返回 jsDelivr CDN 链接

    Args:
        image_path: 本地图片路径
        token: GitHub Personal Access Token
        repo: 仓库名称 (格式: username/repo-name)
        filename: 自定义文件名

    Returns:
        jsDelivr CDN URL 或 None
    """
    import base64
    from tenacity import (
        retry,
        stop_after_attempt,
        retry_if_exception_type,
        before_sleep_log
    )
    import logging

    try:
        if not filename:
            filename = image_path.name

        with open(image_path, 'rb') as f:
            content = base64.b64encode(f.read()).decode()

        # 上传到 GitHub 的 assets 目录
        url = f"https://api.github.com/repos/{repo}/contents/assets/{filename}"

        response = requests.put(
            url,
            headers={
                'Authorization': f'token {token}',
                'Accept': 'application/vnd.github.v3+json'
            },
            json={
                'message': f'Upload {filename}',
                'content': content
            },
            timeout=30
        )

        if response.status_code in [200, 201]:
            # 返回 jsDelivr CDN 链接
            cdn_url = f"https://cdn.jsdelivr.net/gh/{repo}/assets/{filename}"
            return cdn_url
        else:
            print(f"    GitHub API 错误: {response.status_code}")
            if response.status_code >= 500:
                raise requests.exceptions.ServerError(f"Server error: {response.status_code}")
            return None

    except requests.exceptions.SSLError as e:
        print(f"    SSL 错误: {e}")
        raise
    except requests.exceptions.ConnectionError as e:
        print(f"    连接错误: {e}")
        raise
    except requests.exceptions.Timeout as e:
        print(f"    超时: {e}")
        raise
    except Exception as e:
        print(f"    上传失败: {e}")
        return None


def upload_images_to_github(image_paths: List[Path], title: str,
                            token: str = None, repo: str = None) -> List[Optional[str]]:
    """
    批量上传图片到 GitHub

    Args:
        image_paths: 图片路径列表
        title: 笔记标题（用于生成文件名）
        token: GitHub Token
        repo: GitHub 仓库

    Returns:
        CDN URL 列表（失败则为 None）
    """
    if not token or not repo:
        print(f"\n⚠️  未配置 GitHub，跳过图片上传")
        print(f"   配置方法: 设置环境变量 GITHUB_TOKEN 和 GITHUB_REPO")
        print(f"   或创建 ~/.github_upload_config 文件")
        return [None] * len(image_paths)

    # 生成唯一标识符
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    safe_title = re.sub(r'[<>:"/\\|?*]', '_', title)[:30]
    unique_id = hashlib.md5(f"{safe_title}_{timestamp}".encode()).hexdigest()[:8]

    print(f"\n📤 开始上传图片到 GitHub...")
    print(f"   仓库: {repo}")
    print(f"   数量: {len(image_paths)} 张")

    cdn_urls = []

    for i, img_path in enumerate(image_paths, 1):
        # 生成唯一文件名
        ext = img_path.suffix
        filename = f"{timestamp}_{unique_id}_xhs_{i:03d}{ext}"

        print(f"  [{i}/{len(image_paths)}] {img_path.name[:30]}... ", end='', flush=True)

        try:
            url = upload_to_github(img_path, token, repo, filename)
            if url:
                cdn_urls.append(url)
                print(f"✅")
            else:
                cdn_urls.append(None)
                print(f"⚠️  失败")
        except Exception as e:
            cdn_urls.append(None)
            print(f"❌ {str(e)[:30]}")

        time.sleep(0.5)  # 避免 API 限流

    success_count = sum(1 for url in cdn_urls if url)
    print(f"\n✅ 上传完成: {success_count}/{len(image_paths)} 成功")

    return cdn_urls


def replace_local_images_with_cdn(markdown_content: str, image_paths: List[Path],
                                 cdn_urls: List[Optional[str]]) -> str:
    """
    替换 Markdown 中的本地图片路径为 CDN 链接

    Args:
        markdown_content: 原始 Markdown 内容
        image_paths: 本地图片路径列表
        cdn_urls: CDN URL 列表

    Returns:
        替换后的 Markdown 内容
    """
    if not cdn_urls or all(url is None for url in cdn_urls):
        return markdown_content

    # AI 分析中可能包含本地图片引用，我们需要替换它们
    # AI 分析中的图片通常引用本地路径，我们需要替换为 CDN 链接
    content = markdown_content

    # 简单的替换策略：找到所有本地图片路径并替换
    for img_path, cdn_url in zip(image_paths, cdn_urls):
        if cdn_url:
            # 替换绝对路径
            content = content.replace(str(img_path.absolute()), cdn_url)
            # 替换相对路径
            content = content.replace(str(img_path), cdn_url)
            # 替换文件名
            content = content.replace(img_path.name, f"![{img_path.name}]({cdn_url})")

    return content


# ==================== 输出管理 ====================

def save_result(title: str, username: str, text: str, result: str,
                style: str, model: str, token_info: dict, image_count: int,
                image_dir: str, output_dir: str = "xhs_analysis", metadata: dict = None,
                image_paths: List[Path] = None, upload_github: bool = False,
                image_descriptions: List[str] = None) -> Path:
    """
    保存分析结果

    Args:
        title: 笔记标题
        username: 用户名
        text: 原始文案
        result: AI 分析结果
        style: 内容风格
        model: 模型名称
        token_info: Token 使用信息
        image_count: 图片数量
        image_dir: 图片目录
        output_dir: 输出目录
        metadata: 元数据（链接等）
        image_paths: 图片路径列表
        upload_github: 是否上传到 GitHub
        image_descriptions: 每张图片的描述列表
    """
    output_path = Path(output_dir)

    # 保持用户名文件夹结构
    safe_username = re.sub(r'[<>:"/\\|?*]', '_', username)[:30]
    user_output = output_path / safe_username
    user_output.mkdir(parents=True, exist_ok=True)

    # 清理标题作为文件名
    safe_title = re.sub(r'[<>:"/\\|?*]', '_', title)[:50]
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')

    result_file = user_output / f"{safe_title}_{timestamp}.md"

    # 上传图片到 GitHub（如果启用）
    cdn_urls = None
    if upload_github and image_paths:
        token, repo = get_github_config()
        if token and repo:
            cdn_urls = upload_images_to_github(image_paths, title, token, repo)

    with open(result_file, 'w', encoding='utf-8') as f:
        f.write(f"# {title}\n\n")
        f.write(f"## 📌 元信息\n\n")
        f.write(f"| 项目 | 内容 |\n")
        f.write(f"|------|------|\n")
        f.write(f"| **作者** | {username} |\n")
        f.write(f"| **笔记标题** | {title} |\n")
        f.write(f"| **分析时间** | {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} |\n")
        f.write(f"| **使用模型** | {model} |\n")
        f.write(f"| **内容风格** | {CONTENT_STYLES.get(style, {}).get('name', style)} |\n")
        f.write(f"| **图片数量** | {image_count} |\n")
        f.write(f"| **来源目录** | `{image_dir}` |\n")

        # 添加链接信息（如果有）
        if metadata:
            if metadata.get('note_url'):
                f.write(f"| **笔记链接** | [{metadata['note_url']}]({metadata['note_url']}) |\n")
            if metadata.get('user_homepage'):
                f.write(f"| **用户主页** | [{metadata['user_homepage']}]({metadata['user_homepage']}) |\n")

        if token_info and token_info.get('total_tokens', 0) > 0:
            f.write(f"| **Token 使用** | 输入: {token_info.get('prompt_tokens', 0):,} | 输出: {token_info.get('candidates_tokens', 0):,} | **总计: {token_info.get('total_tokens', 0):,}** |\n")

        f.write(f"\n---\n\n")

        # 添加图片展示部分
        if image_paths:
            f.write(f"## 🖼️ 笔记图片\n\n")

            for i, img_path in enumerate(image_paths, 1):
                # 使用 CDN 链接或本地路径
                if cdn_urls and i <= len(cdn_urls) and cdn_urls[i-1]:
                    img_url = cdn_urls[i-1]
                    f.write(f"### 图片 {i}\n\n")
                    f.write(f"![{title} - 图片{i}]({img_url})\n\n")
                else:
                    # 使用相对路径
                    try:
                        rel_path = Path(image_dir).relative_to(Path.cwd()) / img_path.name
                    except ValueError:
                        rel_path = img_path
                    f.write(f"### 图片 {i}\n\n")
                    f.write(f"![{title} - 图片{i}]({rel_path})\n\n")

                # 添加图片描述（如果有）
                if image_descriptions and i <= len(image_descriptions) and image_descriptions[i-1]:
                    f.write(f"**📝 场景描述**: {image_descriptions[i-1]}\n\n")

            f.write(f"---\n\n")

        f.write(f"## 📄 原始文字内容\n\n")
        f.write(f"{text}\n\n")
        f.write(f"---\n\n")
        f.write(f"## 🤖 AI 分析结果\n\n")
        f.write(result)

    return result_file


def load_text_content(image_dir: Path, text_file: str = None) -> Tuple[str, str, dict]:
    """
    从目录加载文字内容

    Args:
        image_dir: 图片目录
        text_file: 指定的文字文件名

    Returns:
        (用户名, 文字内容, 元数据字典)
    """
    # 尝试读取 content.txt
    if text_file:
        text_path = image_dir / text_file
    else:
        text_path = image_dir / "content.txt"

    username = "未知用户"
    text_content = ""
    metadata = {
        'note_url': '',
        'user_homepage': '',
        'title': ''
    }

    if text_path.exists():
        with open(text_path, 'r', encoding='utf-8') as f:
            content = f.read()

        # 尝试提取用户名（从目录名）
        username = image_dir.parent.name

        # 解析元数据
        lines = content.split('\n')
        content_lines = []
        in_content = False

        for line in lines:
            # 提取标题
            if line.startswith('标题:') or line.startswith('Title:'):
                metadata['title'] = line.split(':', 1)[1].strip()
            # 提取笔记链接
            elif line.startswith('链接:') or line.startswith('URL:') or line.startswith('Link:'):
                metadata['note_url'] = line.split(':', 1)[1].strip()
            # 提取用户主页
            elif line.startswith('主页:') or line.startswith('Homepage:') or line.startswith('用户主页:'):
                metadata['user_homepage'] = line.split(':', 1)[1].strip()
            # 提取文案内容
            elif '文案:' in line or 'desc:' in line.lower():
                in_content = True
                continue
            elif in_content:
                content_lines.append(line)

        text_content = '\n'.join(content_lines).strip()

        # 如果没有提取到，使用全部内容
        if not text_content:
            text_content = content

    return username, text_content, metadata


def get_image_files(image_dir: Path) -> List[Path]:
    """获取目录中的所有图片文件"""
    image_extensions = ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.bmp']
    image_paths = set()  # 使用 set 自动去重

    for ext in image_extensions:
        # Windows 不区分大小写，只搜索小写即可
        image_paths.update(image_dir.glob(f"*{ext}"))

    return sorted(image_paths)


def process_single_note(image_dir: str, analyzer: XHSImageAnalyzer,
                        style: str = None, auto_style: bool = True,
                        text_file: str = None, output_dir: str = "xhs_analysis",
                        upload_github: bool = False) -> bool:
    """
    处理单个笔记目录

    Args:
        image_dir: 图片目录路径
        analyzer: 分析器实例
        style: 指定的风格类型
        auto_style: 是否自动检测风格
        text_file: 文字文件名
        output_dir: 输出目录
        upload_github: 是否上传图片到 GitHub

    Returns:
        是否成功
    """
    image_dir = Path(image_dir)

    if not image_dir.is_dir():
        print(f"❌ 目录不存在: {image_dir}")
        return False

    # 获取图片文件
    image_paths = get_image_files(image_dir)

    if not image_paths:
        print(f"❌ 未找到图片文件")
        return False

    print(f"\n{'='*80}")
    # 尝试显示相对路径，如果失败则显示绝对路径
    try:
        display_path = image_dir.relative_to(Path.cwd())
    except ValueError:
        display_path = image_dir
    print(f"📁 笔记目录: {display_path}")
    print(f"👤 作者: {image_dir.parent.name}")
    print(f"📝 标题: {image_dir.name}")
    print(f"📸 图片数量: {len(image_paths)}")
    print(f"{'='*80}")

    # 加载文字内容和元数据
    username, text_content, metadata = load_text_content(image_dir, text_file)
    print(f"📄 文字内容: {len(text_content)} 字符")

    # 上传图片
    uploaded_files = analyzer.upload_images(image_paths)

    if not uploaded_files:
        print(f"❌ 图片上传失败")
        return False

    try:
        # 检测风格
        detected_style = style
        if auto_style and not style:
            detected_style = analyzer.detect_style(text_content, uploaded_files)
        elif style:
            print(f"🎨 指定风格: {CONTENT_STYLES.get(style, {}).get('name', style)}")

        # 分析图文
        result, token_info = analyzer.analyze_note(
            text=text_content,
            image_files=uploaded_files,
            style=detected_style or 'general'
        )

        # 生成每张图片的描述
        print(f"\n📝 生成图片描述...")
        image_descriptions = []
        for i, uploaded_file in enumerate(uploaded_files, 1):
            print(f"  [{i}/{len(uploaded_files)}] ", end='', flush=True)
            description = analyzer.analyze_single_image(uploaded_file)
            image_descriptions.append(description)
            print(f"✅")

        # 删除上传的文件
        analyzer.delete_files(uploaded_files)

        # 保存结果
        if result and not result.startswith("❌"):
            # 保存图片目录的相对路径（如果可能）
            try:
                image_dir_rel = str(image_dir.relative_to(Path.cwd()))
            except ValueError:
                image_dir_rel = str(image_dir)

            result_file = save_result(
                title=image_dir.name,
                username=username,
                text=text_content,
                result=result,
                style=detected_style or 'general',
                model=analyzer.model_name,
                token_info=token_info,
                image_count=len(uploaded_files),
                image_dir=image_dir_rel,
                output_dir=output_dir,
                metadata=metadata,
                image_paths=image_paths,
                upload_github=upload_github,
                image_descriptions=image_descriptions
            )

            # 尝试显示相对路径
            try:
                print(f"💾 结果已保存: {result_file.relative_to(Path.cwd())}")
            except ValueError:
                print(f"💾 结果已保存: {result_file}")

            if token_info and token_info.get('total_tokens', 0) > 0:
                print(f"📊 Token 使用: 输入 {token_info.get('prompt_tokens', 0):,} | 输出 {token_info.get('candidates_tokens', 0):,} | 总计 {token_info.get('total_tokens', 0):,}")

            return True
        else:
            print(f"❌ 分析失败")
            return False

    except Exception as e:
        print(f"❌ 处理失败: {e}")
        return False


def batch_process_user(user_dir: str, analyzer: XHSImageAnalyzer,
                       style: str = None, auto_style: bool = True,
                       output_dir: str = "xhs_analysis") -> Dict[str, int]:
    """
    批量处理用户的所有笔记

    Args:
        user_dir: 用户目录（包含多个笔记子目录）
        analyzer: 分析器实例
        style: 指定的风格类型
        auto_style: 是否自动检测风格
        output_dir: 输出目录

    Returns:
        统计信息字典
    """
    user_path = Path(user_dir)

    if not user_path.is_dir():
        print(f"❌ 目录不存在: {user_dir}")
        return {'total': 0, 'success': 0, 'fail': 0}

    # 查找所有笔记目录（包含图片文件的子目录）
    note_dirs = []
    for item in user_path.iterdir():
        if item.is_dir():
            # 检查是否包含图片文件
            if get_image_files(item):
                note_dirs.append(item)

    if not note_dirs:
        print(f"❌ 未找到包含图片的笔记目录")
        return {'total': 0, 'success': 0, 'fail': 0}

    print(f"\n{'='*80}")
    print(f"👤 用户: {user_path.name}")
    print(f"📊 找到 {len(note_dirs)} 个笔记")
    print(f"{'='*80}")

    stats = {'total': len(note_dirs), 'success': 0, 'fail': 0}

    for i, note_dir in enumerate(note_dirs, 1):
        print(f"\n\n{'#'*80}")
        print(f"# [{i}/{len(note_dirs)}] 处理笔记: {note_dir.name}")
        print(f"{'#'*80}")

        if process_single_note(note_dir, analyzer, style, auto_style, None, output_dir):
            stats['success'] += 1
        else:
            stats['fail'] += 1

        # 避免请求过快
        time.sleep(2)

    print(f"\n\n{'='*80}")
    print(f"📊 批量处理完成")
    print(f"{'='*80}")
    print(f"用户: {user_path.name}")
    print(f"总计: {stats['total']} | 成功: {stats['success']} | 失败: {stats['fail']}")

    return stats


# ==================== 小红书笔记下载功能 ====================

def extract_xhs_note_info(url: str) -> Optional[Dict]:
    """
    从小红书链接提取笔记信息

    Args:
        url: 小红书笔记链接（需要包含 xsec_token）

    Returns:
        包含笔记信息的字典，失败返回 None
    """
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Referer': 'https://www.xiaohongshu.com/',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
        'Accept-Encoding': 'gzip, deflate, br',
        'Connection': 'keep-alive',
    }

    print(f"📡 正在获取笔记信息...")
    print(f"   URL: {url[:80]}...")

    try:
        response = requests.get(url, headers=headers, timeout=30, allow_redirects=True)

        if response.status_code != 200:
            print(f"❌ 请求失败: HTTP {response.status_code}")
            return None

        # 检查是否被重定向到404
        if '/404?' in response.url or '你访问的页面不见了' in response.text:
            print(f"❌ 页面无法访问（可能需要登录或链接已过期）")
            return None

        html = response.text

        # 提取标题
        title = "小红书笔记"
        title_match = re.search(r'<title[^>]*>(.+?)</title>', html)
        if title_match:
            title = title_match.group(1).replace(' - 小红书', '').strip()
            try:
                title = title.encode('raw_unicode_escape').decode('unicode_escape')
            except:
                try:
                    title = title.encode('latin1').decode('utf-8')
                except:
                    pass

        # 提取文案
        desc = ""
        desc_patterns = [r'"desc":"([^"]+)"', r'"desc":\s*"([^"]+)"']
        for pattern in desc_patterns:
            desc_match = re.search(pattern, html)
            if desc_match:
                try:
                    desc = desc_match.group(1).encode('raw_unicode_escape').decode('unicode_escape')
                except:
                    try:
                        desc = desc_match.group(1).encode('latin1').decode('utf-8')
                    except:
                        desc = desc_match.group(1)
                if desc:
                    break

        # 提取图片 URL 和用户名
        image_urls = []
        username = "小红书用户"  # 默认值

        # 查找 __INITIAL_STATE__
        start_idx = html.find('window.__INITIAL_STATE__=')
        if start_idx == -1:
            print(f"⚠️  未找到 __INITIAL_STATE__，用户名可能不准确")
            username = "小红书用户"
        else:
            start_idx += len('window.__INITIAL_STATE__=')
            end_idx = html.find('</script>', start_idx)
            json_str = html[start_idx:end_idx]

            try:
                data = json.loads(json_str)

                # 提取用户名 - 使用多个路径尝试（与 download_xhs_images.py 相同）
                username = "小红书用户"
                user = data.get('user', {}).get('user', {})
                if not user or not user.get('nickname'):
                    user = data.get('user', {}).get('userPageInfo', {}).get('user', {})
                if not user or not user.get('nickname'):
                    # 从 note.noteDetail 提取
                    note = data.get('note', {})
                    note_detail = note.get('noteDetail', {})
                    user = note_detail.get('user', {})

                # 获取 nickname
                if user and user.get('nickname'):
                    username = user.get('nickname')
                elif user:
                    # 尝试其他字段
                    username = (user.get('name') or
                               user.get('nickName') or
                               user.get('username') or "小红书用户")

                # 提取图片 URL
                note = data.get('note', {})
                note_detail = note.get('noteDetail', {})
                image_list = note_detail.get('imageList', [])

                if image_list:
                    for img_obj in image_list:
                        if isinstance(img_obj, dict):
                            url = (img_obj.get('urlDefault') or
                                   img_obj.get('url_default') or
                                   img_obj.get('url'))
                            if url:
                                image_urls.append(url)
            except json.JSONDecodeError:
                print(f"⚠️  JSON 解析失败，使用备用方法提取用户名和图片...")

                # 备用方法：从 HTML 中直接搜索用户名
                user_patterns = [
                    r'"user":\{[^}]*"nickname":"([^"]+)"',  # user 对象内的 nickname
                    r'"nickname":"([^"]+)"',  # 任何 nickname
                    r'"nickName":"([^"]+)"',
                    r'"name":"([^"]+)"',
                ]

                for pattern in user_patterns:
                    match = re.search(pattern, html)
                    if match:
                        try:
                            # 处理 Unicode 转义
                            nickname = match.group(1)
                            try:
                                nickname = nickname.encode('raw_unicode_escape').decode('unicode_escape')
                            except:
                                try:
                                    nickname = nickname.encode('latin1').decode('utf-8')
                                except:
                                    pass

                            # 过滤一些明显不是用户名的值
                            if nickname and len(nickname) > 1 and len(nickname) < 30:
                                if nickname not in ['分享', '推荐', '关注', '粉丝', '笔记', '点赞']:
                                    username = nickname
                                    print(f"   ✅ 从 HTML 提取用户名: {username}")
                                    break
                        except:
                            pass

                # 备用方法：直接搜索图片 URL
                start = json_str.find('"imageList"')
                if start >= 0:
                    bracket_start = json_str.find('[', start)
                    if bracket_start >= 0:
                        depth = 0
                        i = bracket_start
                        while i < len(json_str):
                            if json_str[i] == '[':
                                depth += 1
                            elif json_str[i] == ']':
                                depth -= 1
                                if depth == 0:
                                    bracket_end = i
                                    break
                            i += 1

                        list_content = json_str[bracket_start+1:bracket_end]
                        url_pattern = r'"urlDefault":"([^"]+)"'
                        for match in re.finditer(url_pattern, list_content):
                            url = match.group(1)
                            if url:
                                image_urls.append(url)

        # 去重并清理 URL
        seen = set()
        unique_urls = []
        for url in image_urls:
            url = url.split('?')[0]
            try:
                url = url.encode('utf-8').decode('unicode_escape')
            except:
                pass
            url = url.replace(r'\/', '/')
            if url.startswith('http://'):
                url = 'https://' + url[7:]
            elif not url.startswith('https://'):
                continue
            if url not in seen and 'xhscdn' in url:
                seen.add(url)
                unique_urls.append(url)

        # 提取用户主页链接
        user_homepage = ''
        if start_idx != -1:
            try:
                data = json.loads(json_str)
                user = data.get('user', {}).get('user', {})
                if not user or not user.get('user_id'):
                    user = data.get('user', {}).get('userPageInfo', {}).get('user', {})
                if not user or not user.get('user_id'):
                    note = data.get('note', {})
                    note_detail = note.get('noteDetail', {})
                    user = note_detail.get('user', {})

                if user:
                    user_id = (user.get('user_id') or
                              user.get('userId') or
                              user.get('webId'))
                    if user_id:
                        user_homepage = f"https://www.xiaohongshu.com/user/profile/{user_id}"
            except:
                pass

        result = {
            'title': title,
            'desc': desc,
            'image_urls': unique_urls,
            'note_url': response.url,
            'user_homepage': user_homepage,
            'username': username,  # 添加用户名
        }

        print(f"✅ 成功提取笔记信息")
        print(f"   标题: {title[:50]}...")
        print(f"   作者: {username}")
        print(f"   图片: {len(unique_urls)} 张")
        print(f"   链接: {response.url[:80]}...")

        return result

    except Exception as e:
        print(f"❌ 提取失败: {e}")
        return None


def download_xhs_note(url: str, output_dir: str = "xhs_images") -> Optional[Path]:
    """
    下载小红书笔记的图片和文案

    Args:
        url: 小红书笔记链接
        output_dir: 输出目录

    Returns:
        下载的笔记目录路径，失败返回 None
    """
    # 提取笔记信息
    note_info = extract_xhs_note_info(url)

    if not note_info:
        return None

    if not note_info['image_urls']:
        print(f"❌ 未找到图片")
        return None

    # 使用提取的用户名
    username = note_info.get('username', '小红书用户')

    # 创建目录结构: xhs_images/用户名/笔记标题/
    safe_user = re.sub(r'[<>:"/\\|?*]', '_', username)[:30]
    safe_title = re.sub(r'[<>:"/\\|?*]', '_', note_info['title'])[:50]
    note_path = Path(output_dir) / safe_user / safe_title
    note_path.mkdir(parents=True, exist_ok=True)

    # 保存 content.txt
    content_file = note_path / "content.txt"
    with open(content_file, 'w', encoding='utf-8') as f:
        f.write(f"标题: {note_info['title']}\n")
        if note_info['note_url']:
            f.write(f"链接: {note_info['note_url']}\n")
        if note_info['user_homepage']:
            f.write(f"用户主页: {note_info['user_homepage']}\n")
        f.write(f"\n文案:\n{note_info['desc']}\n")
    print(f"📄 文案已保存")

    # 下载图片
    print(f"\n📥 开始下载 {len(note_info['image_urls'])} 张图片...")
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Referer': 'https://www.xiaohongshu.com/',
    }

    success_count = 0
    for i, img_url in enumerate(note_info['image_urls'], 1):
        try:
            print(f"[{i}/{len(note_info['image_urls'])}] ", end='', flush=True)

            img_response = requests.get(img_url, headers=headers, timeout=30)

            if img_response.status_code == 200:
                content_type = img_response.headers.get('Content-Type', '')
                if 'png' in content_type or img_url.endswith('.png'):
                    ext = '.png'
                elif 'webp' in content_type or img_url.endswith('.webp'):
                    ext = '.webp'
                else:
                    ext = '.jpg'

                filename = f"image_{i:02d}{ext}"
                filepath = note_path / filename

                with open(filepath, 'wb') as f:
                    f.write(img_response.content)

                size = len(img_response.content) / 1024
                print(f"✅ {size:.1f}KB")
                success_count += 1
            else:
                print(f"❌ HTTP {img_response.status_code}")

        except Exception as e:
            print(f"❌ {str(e)[:30]}")

        time.sleep(0.3)

    print(f"\n🎉 下载完成!")
    print(f"   图片: {success_count}/{len(note_info['image_urls'])}")
    print(f"   位置: {note_path.absolute()}")

    return note_path


# ==================== 主程序 ====================

def main():
    import argparse

    parser = argparse.ArgumentParser(
        description="小红书图文笔记分析工具（支持从URL直接下载并分析）",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
使用示例:

1. 从 URL 直接下载并分析（推荐）:
   python xhs_image_analysis.py --url "小红书完整链接"

2. 分析单个笔记（自动检测风格）:
   python xhs_image_analysis.py --dir "xhs_images/用户名/笔记标题"

3. 指定内容风格:
   python xhs_image_analysis.py --dir "images" --style quote_wisdom

4. 批量分析用户的所有笔记:
   python xhs_image_analysis.py --user-dir "xhs_images/塑料叉FOKU"

5. 读取指定文案文件:
   python xhs_image_analysis.py --dir "images" --text-file "my_content.txt"

6. 使用不同的模型:
   python xhs_image_analysis.py --url "笔记链接" --model flash

7. 上传图片到 GitHub:
   python xhs_image_analysis.py --url "笔记链接" --upload-github
        """
    )

    parser.add_argument('--url', help='小红书笔记链接（会自动下载并分析）')
    parser.add_argument('--dir', help='单个笔记的图片文件夹路径')
    parser.add_argument('--user-dir', help='用户文件夹路径（批量处理该用户的所有笔记）')
    parser.add_argument('--style', choices=list(CONTENT_STYLES.keys()),
                        help='指定内容风格类型')
    parser.add_argument('--auto-style', action='store_true', default=True,
                        help='自动检测内容风格（默认启用）')
    parser.add_argument('--no-auto-style', action='store_false', dest='auto_style',
                        help='禁用自动风格检测，使用通用分析')
    parser.add_argument('--text-file', help='指定文案文件名（默认为 content.txt）')
    parser.add_argument('--model', choices=['flash', 'flash-lite', 'pro'],
                        default='flash-lite', help='Gemini 模型（默认: flash-lite）')
    parser.add_argument('-o', '--output', default='xhs_analysis',
                        help='输出目录（默认: xhs_analysis）')
    parser.add_argument('--api-key', help='Gemini API Key（覆盖配置文件）')
    parser.add_argument('--list-styles', action='store_true',
                        help='列出所有支持的内容风格类型')
    parser.add_argument('--download-only', action='store_true',
                        help='只下载不分析（仅用于 --url）')
    parser.add_argument('--upload-github', action='store_true',
                        help='上传图片到 GitHub CDN（需要配置 GITHUB_TOKEN 和 GITHUB_REPO）')

    args = parser.parse_args()

    # 列出风格类型
    if args.list_styles:
        print("\n📋 支持的内容风格类型:\n")
        for key, info in CONTENT_STYLES.items():
            print(f"   {key:15} - {info['name']}")
            print(f"{'':15}    关键词: {', '.join(info['keywords'])}")
            print(f"{'':15}    描述: {info['description']}\n")
        return

    # 检查参数
    if not args.url and not args.dir and not args.user_dir:
        parser.print_help()
        return

    # 初始化分析器
    try:
        analyzer = XHSImageAnalyzer(model=args.model, api_key=args.api_key)
    except ValueError as e:
        print(f"❌ {e}")
        return

    print(f"\n{'='*80}")
    print(f"🖼️  小红书图文笔记分析工具")
    print(f"{'='*80}")

    # 处理 URL 下载
    if args.url:
        print(f"\n📥 从 URL 下载笔记...")
        note_dir = download_xhs_note(args.url)

        if not note_dir:
            print(f"\n❌ 下载失败!")
            return

        if args.download_only:
            print(f"\n✅ 下载完成（不分析）")
            return

        # 下载后自动分析
        print(f"\n🤖 开始分析...")
        success = process_single_note(
            image_dir=str(note_dir),
            analyzer=analyzer,
            style=args.style,
            auto_style=args.auto_style,
            text_file=None,
            output_dir=args.output,
            upload_github=args.upload_github
        )

        if success:
            print(f"\n✅ 完成!")
        else:
            print(f"\n❌ 分析失败!")
        return

    # 处理单个笔记
    if args.dir:
        success = process_single_note(
            image_dir=args.dir,
            analyzer=analyzer,
            style=args.style,
            auto_style=args.auto_style,
            text_file=args.text_file,
            output_dir=args.output,
            upload_github=args.upload_github
        )

        if success:
            print(f"\n✅ 完成!")
        else:
            print(f"\n❌ 失败!")

    # 批量处理用户笔记
    elif args.user_dir:
        stats = batch_process_user(
            user_dir=args.user_dir,
            analyzer=analyzer,
            style=args.style,
            auto_style=args.auto_style,
            output_dir=args.output
        )

        if stats['success'] > 0:
            print(f"\n✅ 完成!")
        else:
            print(f"\n❌ 全部失败!")


if __name__ == "__main__":
    main()
